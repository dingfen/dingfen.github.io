<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰ - å³°å­çš„ä¹å›­</title>
<meta name="description" content="å¯¹ Cyber RT çš„é€šä¿¡æ¶æ„çš„æ·±å…¥ç ”ç©¶">


  <meta name="author" content="Bill Ding">


<meta property="og:type" content="article">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="å³°å­çš„ä¹å›­">
<meta property="og:title" content="Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰">
<meta property="og:url" content="https://dingfen.github.io/apollo/2020/11/07/CyberCommu2.html">


  <meta property="og:description" content="å¯¹ Cyber RT çš„é€šä¿¡æ¶æ„çš„æ·±å…¥ç ”ç©¶">



  <meta property="og:image" content="https://dingfen.github.io/assets/img/teaser.jpg">





  <meta property="article:published_time" content="2020-11-07T00:00:00+08:00">





  

  


<link rel="canonical" href="https://dingfen.github.io/apollo/2020/11/07/CyberCommu2.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Bill Ding",
      "url": "https://dingfen.github.io/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="å³°å­çš„ä¹å›­ Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single categories">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          å³°å­çš„ä¹å›­
          <span class="site-subtitle">åˆæŠ±ä¹‹æœ¨ï¼Œç”Ÿäºæ¯«æœ«ï¼›ä¹å±‚ä¹‹å°ï¼Œèµ·äºç´¯åœŸï¼›åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹</span>
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/home/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/home/blog">Blogs</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="https://google.com">External Link</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">åˆ‡æ¢èœå•</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay" style=" background-image: url('/assets/img/teaser.jpg');">
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰

        
      </h1>
      
        <p class="page__lead">å¯¹ Cyber RT çš„é€šä¿¡æ¶æ„çš„æ·±å…¥ç ”ç©¶
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  10 minutes read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/img/avatar.jpg" alt="Bill Ding" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bill Ding</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Programmer, Graduate majored in CS</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Hefei, Anhui, China</span>
        </li>
      

      
        
          
            <li><a href="df12138@mail.ustc.edu.cn" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://github.com/dingfen" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰">
    <meta itemprop="description" content="å¯¹ Cyber RT çš„é€šä¿¡æ¶æ„çš„æ·±å…¥ç ”ç©¶">
    <meta itemprop="datePublished" content="2020-11-07T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> ç›®å½•</h4></header>
              <ul class="toc__menu">
  <li>
<a href="#apollo-cyber-rt-%E9%80%9A%E4%BF%A1%E4%B8%8B">Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰</a>
    <ul>
      <li><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></li>
      <li>
<a href="#receiver--transmitter">Receiver &amp; Transmitter</a>
        <ul>
          <li><a href="#receivermanager">ReceiverManager</a></li>
          <li><a href="#transport">Transport</a></li>
          <li><a href="#receiver--transmitter-1">Receiver &amp; Transmitter</a></li>
        </ul>
      </li>
      <li>
<a href="#data-%E9%83%A8%E5%88%86">Data éƒ¨åˆ†</a>
        <ul>
          <li><a href="#datavisitor">DataVisitor</a></li>
          <li><a href="#datadispatcher">DataDispatcher</a></li>
          <li><a href="#datanotifier">DataNotifier</a></li>
          <li><a href="#datafusion--alllatest">DataFusion &amp; AllLatest</a></li>
          <li><a href="#channelbuffer--cachebuffer">ChannelBuffer &amp; CacheBuffer</a></li>
        </ul>
      </li>
      <li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
      <li><a href="#%E5%8F%82%E8%80%83">å‚è€ƒ</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="apollo-cyber-rt-é€šä¿¡ä¸‹">Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰</h1>

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>æ¬¢è¿å›æ¥ï¼ä»Šå¤©æˆ‘ç»§ç»­å’Œå¤§å®¶èŠ Cyber RT çš„é€šä¿¡ï¼Œ<a href="https://dingfen.github.io/apollo/2020/11/03/CyberCommu1.html">ä¸Šæ–‡</a>æˆ‘æ¢è®¨äº† Cyber RT çš„ä¸¤ç§é€šä¿¡æ–¹å¼å’Œä¸‰ç§é€šä¿¡æ¨¡å‹ï¼Œå¹¶ä»é€šä¿¡æ¶æ„çš„è§’åº¦ï¼Œä¸€å±‚å±‚åœ°ç»™å¤§å®¶è¯¦ç»†ä»‹ç»äº†é€šä¿¡æ—¶ä»£ç çš„å…·ä½“å·¥ä½œæƒ…å†µã€‚ç”±äºé€šä¿¡å†…å®¹è¿‡å¤šï¼Œå…¨æ”¾åœ¨ä¸€ç¯‡åšå®¢ç†è®ºå¤ªé•¿ï¼Œäºæ˜¯æˆ‘å°†è¿™äº›å†…å®¹ç®€å•åœ°ä¸€åˆ†ä¸ºäºŒï¼Œäº‹å®ä¸Šå®ƒä»¬åº”å½“æ˜¯æœ‰æœºçš„æ•´ä½“ã€‚</p>

<p>ä¸Šæ–‡æœ«å°¾ï¼Œæˆ‘ä»‹ç»äº† <code class="language-plaintext highlighter-rouge">Blocker</code> ç±»çš„åŠŸèƒ½ï¼Œä»Šå¤©è¿™ç¯‡åšå®¢ï¼Œæˆ‘ä»¬ç»§ç»­å‘æ·±å¤„è¿›å†›â†–(^Ï‰^)â†—ã€‚</p>

<center>
<img src="/assets/img/CyberLayer.png">
</center>
<h2 id="receiver--transmitter">Receiver &amp; Transmitter</h2>

<p>æˆ‘ä»¬åœ¨ä¸Šæ–‡å·²ç»è®¤è¯†äº† <code class="language-plaintext highlighter-rouge">Reader</code> å’Œ <code class="language-plaintext highlighter-rouge">Writer</code> ï¼Œç°åœ¨ç»§ç»­å¾€ä¸‹èµ°ã€‚å¦‚æœä½ ä»”ç»†çœ‹ä»£ç çš„è¯ï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">Reader</code> å’Œ <code class="language-plaintext highlighter-rouge">Writer</code> åˆå§‹åŒ–æ—¶ï¼Œéƒ½ä¼šåˆ†åˆ«æ„å»ºå¥½åº•å±‚çš„ <code class="language-plaintext highlighter-rouge">Receiver</code> å’Œ <code class="language-plaintext highlighter-rouge">Transmitter</code> å¯¹è±¡ã€‚ä¸ºäº†æè¿°ç®€ä¾¿ï¼Œæˆ‘ä¹‹å‰æœ‰æ„åœ°å¿½ç•¥äº†ï¼Œç°åœ¨æŠŠå®ƒæ‹¿å‡ºæ¥ã€‚<code class="language-plaintext highlighter-rouge">Reader</code> éƒ¨åˆ†çš„æ¯”è¾ƒå¤æ‚ï¼Œè¿˜ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">ReceiverManager</code> è¿›è¡Œç®¡ç†ï¼›<code class="language-plaintext highlighter-rouge">Writer</code> å°±æ¯”è¾ƒç›´æ¥äº†ï¼Œåœ¨ <code class="language-plaintext highlighter-rouge">Init()</code> å‡½æ•°ä¸­å¯ä»¥ç›´æ¥çœ‹åˆ°ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">Reader</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;::</span><span class="n">Init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">receiver_</span> <span class="o">=</span> <span class="n">ReceiverManager</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetReceiver</span><span class="p">(</span><span class="n">role_attr_</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Writer</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;::</span><span class="n">Init</span><span class="p">()</span> <span class="p">{</span>
   <span class="cm">/*  ....   */</span>
    <span class="n">transmitter_</span> <span class="o">=</span>
        <span class="n">transport</span><span class="o">::</span><span class="n">Transport</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">CreateTransmitter</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;</span><span class="p">(</span><span class="n">role_attr_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬ä¸å¦¨æŠŠè¿™é‡Œä½œä¸ºçªç ´å£ï¼Œæ‰“å¼€æ–°ä¸–ç•Œçš„å¤§é—¨ã€‚</p>

<p><span id="1"></span></p>

<h3 id="receivermanager">ReceiverManager</h3>

<p>ä¹‹å‰æåˆ°è¿‡ï¼Œ<code class="language-plaintext highlighter-rouge">Reader</code> åœ¨åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦ç”¨ <code class="language-plaintext highlighter-rouge">ReceiverManager::GetReceiver()</code> è·å¾— <code class="language-plaintext highlighter-rouge">Receiver</code> å¯¹è±¡ã€‚å®ƒçš„å†…éƒ¨åˆ†å°è£…äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">unordered_map</code> è¡¨ï¼Œå°†ä¿¡é“åå­—å’Œä¸ä¹‹å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">Receiver</code> å¯¹è±¡ä¿å­˜åœ¨è¡¨ä¸­ã€‚å†çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå¯å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œ<em>å¦‚æœåŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œä¸åŒçš„ <code class="language-plaintext highlighter-rouge">Reader</code> å¯¹è±¡è®¢é˜…åŒä¸€ä¸ªä¿¡é“ï¼Œäº‹å®ä¸Šä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Receiver</code></em> <sup>2</sup>ã€‚å†çœ‹çœ‹é‚£ä¸ªå¾ˆé•¿çš„ <code class="language-plaintext highlighter-rouge">CreateReceiver()</code> å‡½æ•°è°ƒç”¨ï¼Œé™¤äº†ä¼ é€’ä¸€ä¸ªé…ç½®ä¿¡æ¯å‚æ•°å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé•¿çš„å›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°ä¼šåšï¼š</p>

<ul>
  <li>åŠ å…¥ä¸€ä¸ª Transport äº‹ä»¶ï¼Œç±»å‹ä¸º Dispatch</li>
  <li>è°ƒç”¨æ•°æ®åˆ†å‘å™¨ <code class="language-plaintext highlighter-rouge">DataDispatcher::Dispatch()</code>  å‡½æ•°</li>
  <li>åŠ å…¥ä¸€ä¸ª Transport äº‹ä»¶ï¼Œç±»å‹ä¸º Notify</li>
</ul>

<p>è¿™äº›æ­¥éª¤å…·ä½“åšäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ç›®å‰è¿˜ä¸çŸ¥é“ï¼Œæ±‚çŸ¥çš„æ¬²æœ›é©±ä½¿ç€æˆ‘ä»¬ç»§ç»­å¾€ä¸‹æ¢ç´¢ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">MessageT</span><span class="p">&gt;</span>
<span class="k">auto</span> <span class="n">ReceiverManager</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;::</span><span class="n">GetReceiver</span><span class="p">(</span><span class="k">const</span> <span class="n">proto</span><span class="o">::</span><span class="n">RoleAttributes</span><span class="o">&amp;</span> <span class="n">role_attr</span><span class="p">)</span> 
    <span class="o">-&gt;</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">transport</span><span class="o">::</span><span class="n">Receiver</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="c1">// because multi reader for one channel will write datacache multi times,</span>
  <span class="c1">// so reader for datacache we use map to keep one instance for per channel</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">channel_name</span> <span class="o">=</span> <span class="n">role_attr</span><span class="p">.</span><span class="n">channel_name</span><span class="p">();</span>
    <span class="c1">// å¦‚æœä¿¡é“åå­—å¯¹åº”çš„ Receiver è¿˜æ²¡æœ‰åˆ›å»º é‚£å°±åˆ›å»º</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">receiver_map_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">channel_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// ä¸€ä¸ªå·¨é•¿çš„ CreateReceiver() å‡½æ•°è°ƒç”¨</span>
    <span class="n">receiver_map_</span><span class="p">[</span><span class="n">channel_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">transport</span><span class="o">::</span><span class="n">Transport</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">CreateReceiver</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;</span><span class="p">(</span>
            		<span class="n">role_attr</span><span class="p">,</span> <span class="p">[](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;&amp;</span> <span class="n">msg</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">transport</span><span class="o">::</span><span class="n">MessageInfo</span><span class="o">&amp;</span> <span class="n">msg_info</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">proto</span><span class="o">::</span><span class="n">RoleAttributes</span><span class="o">&amp;</span> <span class="n">reader_attr</span><span class="p">)</span> <span class="p">{</span>
              <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">msg_info</span><span class="p">;</span>
              <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">reader_attr</span><span class="p">;</span>
              <span class="n">PerfEventCache</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddTransportEvent</span><span class="p">(</span>
                  <span class="n">TransPerf</span><span class="o">::</span><span class="n">DISPATCH</span><span class="p">,</span> <span class="n">reader_attr</span><span class="p">.</span><span class="n">channel_id</span><span class="p">(),</span>
                  <span class="n">msg_info</span><span class="p">.</span><span class="n">seq_num</span><span class="p">());</span>
              <span class="n">data</span><span class="o">::</span><span class="n">DataDispatcher</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Dispatch</span><span class="p">(</span>
                  <span class="n">reader_attr</span><span class="p">.</span><span class="n">channel_id</span><span class="p">(),</span> <span class="n">msg</span><span class="p">);</span>
              <span class="n">PerfEventCache</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddTransportEvent</span><span class="p">(</span>
                  <span class="n">TransPerf</span><span class="o">::</span><span class="n">NOTIFY</span><span class="p">,</span> <span class="n">reader_attr</span><span class="p">.</span><span class="n">channel_id</span><span class="p">(),</span>
                  <span class="n">msg_info</span><span class="p">.</span><span class="n">seq_num</span><span class="p">());</span>
            <span class="p">});</span>
  <span class="p">}</span>
    <span class="c1">// å¦‚æœå·²ç»æœ‰äº† ç›´æ¥è¿”å›</span>
  <span class="k">return</span> <span class="n">receiver_map_</span><span class="p">[</span><span class="n">channel_name</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="transport">Transport</h3>

<p><code class="language-plaintext highlighter-rouge">Transport</code> ç±»ï¼Œå•ä¾‹æ¨¡å¼ï¼Œæœ‰å¦‚ä¸‹æŒ‡é’ˆæˆå‘˜ï¼Œemmâ€¦â€¦åœ¨è¿˜æ²¡å®Œå…¨å¼„æ‡‚åº•å±‚ä»£ç çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¾ˆéš¾å‘Šè¯‰ä½ ä»¬è¿™äº›ç±»çš„å…·ä½“ä½œç”¨ï¼š</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Participant</code> ç±»  FastRtps ç›¸å…³</li>
  <li>
<code class="language-plaintext highlighter-rouge">Notifier</code> ç±» ä¸ Shm ç›¸å…³</li>
  <li>
<code class="language-plaintext highlighter-rouge">IntraDispatcher</code> ç±» Intra çš„åˆ†å‘å™¨</li>
  <li>
<code class="language-plaintext highlighter-rouge">ShmDispatcher</code> ç±» Shm çš„åˆ†å‘å™¨</li>
  <li>
<code class="language-plaintext highlighter-rouge">RtpsDispatcher</code> ç±» Rtps çš„åˆ†å‘å™¨</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Transport</span> <span class="p">{</span>
 <span class="nl">private:</span>
  <span class="n">ParticipantPtr</span> <span class="n">participant_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">NotifierPtr</span> <span class="n">notifier_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">IntraDispatcherPtr</span> <span class="n">intra_dispatcher_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">ShmDispatcherPtr</span> <span class="n">shm_dispatcher_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">RtpsDispatcherPtr</span> <span class="n">rtps_dispatcher_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å’Œä¹‹å‰ Cyber RT ç»™äººçš„æ„Ÿè§‰ä¸€æ ·ï¼Œä¸€æ—¦å®ƒè¦åˆ›å»ºä»€ä¹ˆé‡è¦çš„ä¸œè¥¿ï¼Œä¸è°ƒç”¨ä¸ªå‡ å±‚æ˜¯æ ¹æœ¬ä¸å¯èƒ½å®Œæˆçš„ã€‚åœ¨è¿™é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">Transport</code> ç±»çš„ä¸¤ä¸ªå‡½æ•° <code class="language-plaintext highlighter-rouge">CreateTransmitter</code> å’Œ <code class="language-plaintext highlighter-rouge">CreateReceiver</code> éƒ½ä¼šæ ¹æ®ä¼ å…¥çš„ mode ï¼Œå»æ„é€ å‡ºå¯¹åº”çš„å­ç±»å¯¹è±¡ï¼Œåˆ†åˆ«å¯¹åº”æˆ‘åœ¨è¿™ç¯‡åšå®¢å¼€å¤´æåˆ°çš„å››ç§ä¸åŒåœºæ™¯ä¸‹çš„ä¼ è¾“å®ç°ç±»ã€‚å“¦ï¼Œæé†’ä¸€ä¸‹ï¼Œé»˜è®¤çš„ mode æ˜¯ Hybrid ï¼Œä¹Ÿå°±æ˜¯ä¸‰ç§æ¨¡å¼æ··ç”¨ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="k">auto</span> <span class="n">Transport</span><span class="o">::</span><span class="n">CreateTransmitter</span><span class="p">(</span><span class="k">const</span> <span class="n">RoleAttributes</span><span class="o">&amp;</span> <span class="n">attr</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">OptionalMode</span><span class="o">&amp;</span> <span class="n">mode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Transmitter</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="cm">/*  ....  */</span>
 <span class="c1">// å¾€ modified_attr ä¸­åŠ å…¥ qos profile</span>
 <span class="c1">// æ ¹æ®å„ç§æ¨¡å¼ åˆ›å»ºç›¸åº”çš„ Transmitter å­ç±»</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">INTRA</span><span class="p">:</span>
      <span class="n">transmitter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IntraTransmitter</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">SHM</span><span class="p">:</span>
      <span class="n">transmitter</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ShmTransmitter</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">RTPS</span><span class="p">:</span>
      <span class="n">transmitter</span> <span class="o">=</span>
          <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">RtpsTransmitter</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">,</span> <span class="n">participant</span><span class="p">());</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">transmitter</span> <span class="o">=</span>
          <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">HybridTransmitter</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">,</span> <span class="n">participant</span><span class="p">());</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">HYBRID</span><span class="p">)</span>
    <span class="n">transmitter</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">transmitter</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Transmitter</code> ç±»æ˜¯å†™æ¶ˆæ¯ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">Receiver</code> ç±»æ˜¯è¯»æ¶ˆæ¯ï¼Œå› æ­¤ <code class="language-plaintext highlighter-rouge">Receiver</code> ç±»æ¯” <code class="language-plaintext highlighter-rouge">Transmitter</code> ç±»å¤šäº†ä¸€ä¸ªå‚æ•° <code class="language-plaintext highlighter-rouge">MessageListener</code> ï¼Œå…¶æœ¬è´¨å°±æ˜¯ä¸ªå›è°ƒå‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">MessageListener</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="k">const</span> <span class="n">MessagePtr</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">MessageInfo</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">RoleAttributes</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="k">auto</span> <span class="n">Transport</span><span class="o">::</span><span class="n">CreateReceiver</span><span class="p">(</span><span class="k">const</span> <span class="n">RoleAttributes</span><span class="o">&amp;</span> <span class="n">attr</span><span class="p">,</span>
    <span class="k">const</span> <span class="k">typename</span> <span class="n">Receiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;::</span><span class="n">MessageListener</span><span class="o">&amp;</span> <span class="n">msg_listener</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">OptionalMode</span><span class="o">&amp;</span> <span class="n">mode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Receiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
 <span class="cm">/*  ....   */</span>
 <span class="c1">// å¾€ modified_attr ä¸­åŠ å…¥ qos profile</span>
 <span class="c1">// æ ¹æ®å„ç§æ¨¡å¼ åˆ›å»ºç›¸åº”çš„ Receiver å­ç±»</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">INTRA</span><span class="p">:</span>
      <span class="n">receiver</span> <span class="o">=</span>
          <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IntraReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">,</span> <span class="n">msg_listener</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">SHM</span><span class="p">:</span>
      <span class="n">receiver</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ShmReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">,</span> <span class="n">msg_listener</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">RTPS</span><span class="p">:</span>
      <span class="n">receiver</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">RtpsReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">modified_attr</span><span class="p">,</span> <span class="n">msg_listener</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">receiver</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">HybridReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;&gt;</span><span class="p">(</span>
          <span class="n">modified_attr</span><span class="p">,</span> <span class="n">msg_listener</span><span class="p">,</span> <span class="n">participant</span><span class="p">());</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OptionalMode</span><span class="o">::</span><span class="n">HYBRID</span><span class="p">)</span>
    <span class="n">receiver</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">receiver</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€åä¸€éƒ¨åˆ†ä»£ç ï¼šåœ¨ <code class="language-plaintext highlighter-rouge">Receiver</code> å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œåªè¦æ¨¡å¼ä¸æ˜¯ Hybridï¼Œéƒ½ä¼šç«‹åˆ»è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Receiver::Enable()</code> å‡½æ•°å¼€å¯æ¥æ”¶ã€‚</p>

<p><span id="2"></span></p>

<h3 id="receiver--transmitter-1">Receiver &amp; Transmitter</h3>

<p>è¿™ä¸¤ä¸ªç±»æ˜¯ <code class="language-plaintext highlighter-rouge">EndPoint</code> çš„å­ç±»ã€‚å…³äº <code class="language-plaintext highlighter-rouge">Endpoint</code> ç±»<sup>5</sup>ï¼Œé‚£å¯å°±æ˜¯æ•´ä¸ªæ¶æ„çš„ç±»ç»§æ‰¿çš„ç»ˆç‚¹äº†ï¼Œå…¶å†…éƒ¨æœ‰ä¸‰ä¸ªæˆå‘˜</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">bool enabled_</code> ç”¨æ¥æ ‡è®°æ˜¯å¦è¢«å¯ç”¨</li>
  <li>
<code class="language-plaintext highlighter-rouge">Identity id_</code> ç”¨äºæ ‡è¯†ï¼Œå¯¹äºæ¯ä¸ª <code class="language-plaintext highlighter-rouge">Endpoint</code> å¯¹è±¡æ‹¥æœ‰å”¯ä¸€çš„ id å·ï¼Œå…¶å­ç±»ä¹Ÿæ˜¯ç”¨è¿™ä¸ªæ¥è¿›è¡Œæ ‡è¯†</li>
  <li>
<code class="language-plaintext highlighter-rouge">RoleAttributes attr_</code> ç”¨æ¥è®°å½•é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚</li>
</ul>

<p>å…¶ä¸­ <code class="language-plaintext highlighter-rouge">Receiver</code> ç±»åªæœ‰ä¸€ä¸ªå›è°ƒå‡½æ•° <code class="language-plaintext highlighter-rouge">msg_listener_</code>ï¼Œè¯¥å›è°ƒå‡½æ•°å°±æ˜¯ <code class="language-plaintext highlighter-rouge">Receiver</code> æ„é€ æ—¶ä¼ å…¥çš„å‡½æ•°ã€‚åœ¨æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œä¼šè¢«è°ƒç”¨ğŸ‘‡ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">Receiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;::</span><span class="n">OnNewMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">MessagePtr</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">MessageInfo</span><span class="o">&amp;</span> <span class="n">msg_info</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">msg_listener_</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span>
    <span class="n">msg_listener_</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_info</span><span class="p">,</span> <span class="n">attr_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ <a href="#1">ReceiverManager</a> é‚£ä¸€å°èŠ‚ä¸­ï¼Œå·²ç»è¯´åˆ°è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼Œå…¶ä¸­<sup>5</sup>ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">DataDispatcher::Dispatch</code> éå¸¸å…³é”®ã€‚å› ä¸ºä»è¿™æ­¥å¯ä»¥çœ‹å‡ºä¸Šå±‚å’Œåº•å±‚æœ€ç»ˆå®Œæˆäº†é—­ç¯ã€‚å½“åº•å±‚ <code class="language-plaintext highlighter-rouge">Receiver</code> çš„å›è°ƒå‡½æ•° <code class="language-plaintext highlighter-rouge">msg_listener</code> æ”¶åˆ°æ¶ˆæ¯è¢«è°ƒç”¨æ—¶ï¼Œä¸Šå±‚çš„åˆ†å‘å™¨ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> ä¼šæŠŠæ¥è‡ªåº•å±‚çš„æ¶ˆæ¯å‘åˆ°ç­‰å¾…çš„æ¶ˆæ¯ç¼“å­˜é‡Œï¼Œç„¶åè°ƒç”¨ä¸Šå±‚çš„é€šçŸ¥å™¨ <code class="language-plaintext highlighter-rouge">DataNotifier::Notify()</code> ï¼Œå”¤é†’å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">Component</code> çš„å°è£…äº† <code class="language-plaintext highlighter-rouge">Process()</code> çš„åç¨‹ï¼Œè®©åç¨‹å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</p>

<p>å†çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">Receiver</code> çš„å››ä¸ªå­ç±»ï¼Œæ¯ä¸ªå­ç±»éƒ½åŒ…å«äº†ç›¸åº”çš„ Dispatcher çš„æŒ‡é’ˆï¼Œä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">RtpsReceiver</code> ç±»å«æœ‰ <code class="language-plaintext highlighter-rouge">RtpsDispatcherPtr</code> æˆå‘˜ã€‚è¿™äº› Dispatcher çš„åŠŸèƒ½å°±æ˜¯å¢åˆ ç›‘å¬è€…ï¼Œä»è€Œè®© <code class="language-plaintext highlighter-rouge">Receiver</code> å…³é—­æˆ–å¼€å¯ï¼Œæ¯”å¦‚ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">RtpsReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;::</span><span class="n">Enable</span><span class="p">()</span> <span class="p">{</span>
 <span class="cm">/*  ....  */</span>
  <span class="n">dispatcher_</span><span class="o">-&gt;</span><span class="n">AddListener</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">attr_</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RtpsReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;::</span><span class="n">OnNewMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span>
                             <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_2</span><span class="p">));</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">enabled_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">RtpsReceiver</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;::</span><span class="n">Disable</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">dispatcher_</span><span class="o">-&gt;</span><span class="n">RemoveListener</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">attr_</span><span class="p">);</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">enabled_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç®€å•åœ°ä»‹ç»ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">Dispatcher</code> ç±»ï¼ˆåˆ«å’Œä¸‹é¢çš„ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> ææ··äº†ï¼‰ã€‚å®ƒä¸»è¦è´Ÿè´£è®°å½•ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">channel_id</code> å’Œå¯¹åº” <code class="language-plaintext highlighter-rouge">ListenerHandlerBasePtr</code> çš„å…³ç³»è¡¨ã€‚è€Œ<code class="language-plaintext highlighter-rouge">AddListener()</code> å’Œ <code class="language-plaintext highlighter-rouge">RemoveListener()</code> å‡½æ•°æ˜¯ä»å…³ç³»è¡¨ä¸­ï¼Œæ‹¿åˆ°ç»™å®šä¿¡é“çš„å¯¹åº” <code class="language-plaintext highlighter-rouge">ListenerHandlerBase</code> ï¼Œå¹¶åœ¨è¿™ä¸Šé¢è¿æ¥ï¼ˆConnectï¼‰æˆ–ä¸è¿æ¥ï¼ˆDisconnectï¼‰ç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚ç”±äºæ—¶é—´ç²¾åŠ›æœ‰é™ï¼Œè¿™è¾¹è§£é‡Šå¾—æ¯”è¾ƒæ··ä¹±ï¼Œè‹¥æƒ³å…·ä½“äº†è§£å…¶å·¥ä½œæœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æœ€åçš„æ–‡çŒ®ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æœ‰ç‚¹åƒåœ¨ <a href="https://www.qt.io/cn">Qt</a> ä¸­å®ç°çš„ä¿¡å·æ§½æœºåˆ¶ï¼šä¿¡å·åœ¨ç‰¹å®šæƒ…å†µä¸‹è¢«å‘å°„å‡ºå»ï¼Œå¯¹åº”çš„ä¿¡å·å“åº”å‡½æ•°åœ¨æ§½ä¸­ç›‘å¬ã€‚ä¿¡å·ä¸æ§½é€šè¿‡ Connect å‡½æ•°å…³è”ï¼Œä¸€ä¸ªä¿¡å·å¯ä»¥å‘å°„åˆ°å¤šä¸ªæ§½ï¼Œå¤šä¸ªä¿¡å·å¯ä»¥è¢«ä¸€ä¸ªæ§½ç›‘å¬ã€‚</p>

<hr>

<p>å†æ¥çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">Transmitter</code> ç±»ï¼Œå®ƒæ˜¯çœŸæ­£çš„æ•°æ®å†™è€…çš„åŸºç±»ã€‚å®ƒæœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œåˆ†åˆ«ä¸ºåºåˆ—å· <code class="language-plaintext highlighter-rouge">seq_num_</code> å’Œæ¶ˆæ¯ä¿¡æ¯ <code class="language-plaintext highlighter-rouge">msg_info_</code> ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">Transmitter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Endpoint</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="k">explicit</span> <span class="n">Transmitter</span><span class="p">(</span><span class="k">const</span> <span class="n">RoleAttributes</span><span class="o">&amp;</span> <span class="n">attr</span><span class="p">);</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Transmit</span><span class="p">(</span><span class="k">const</span> <span class="n">MessagePtr</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">);</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Transmit</span><span class="p">(</span><span class="k">const</span> <span class="n">MessagePtr</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">,</span> <span class="k">const</span> <span class="n">MessageInfo</span><span class="o">&amp;</span> <span class="n">msg_info</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kt">uint64_t</span> <span class="n">NextSeqNum</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">++</span><span class="n">seq_num_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">uint64_t</span> <span class="n">seq_num</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">seq_num_</span><span class="p">;</span> <span class="p">}</span>
 <span class="nl">protected:</span>
  <span class="kt">uint64_t</span> <span class="n">seq_num_</span><span class="p">;</span>
  <span class="n">MessageInfo</span> <span class="n">msg_info_</span><span class="p">;</span>
<span class="p">};</span>

</code></pre></div></div>

<p>æˆ‘ä¸»è¦ç ”ç©¶å…¶ä¸­çš„ <code class="language-plaintext highlighter-rouge">Transmit()</code> å‡½æ•°ï¼Œå…¶å››ä¸ªå­ç±»éƒ½å…·ä½“å®ç°äº† <code class="language-plaintext highlighter-rouge">Transmit()</code> å‡½æ•°ï¼Œå¦‚æœä½ ä»”ç»†çœ‹è¿‡å‰ä¸€ç¯‡åšå®¢ï¼Œå°±çŸ¥é“è¿™ä¹Ÿæ˜¯ <code class="language-plaintext highlighter-rouge">Writer</code> ç±»ä¸€ç›´åœ¨è°ƒç”¨çš„å‡½æ•°ã€‚é‚£ä¹ˆè¿™ä¸ª <code class="language-plaintext highlighter-rouge">Transmit()</code> å‡½æ•°æœ‰ä»€ä¹ˆå…·ä½“æ­¥éª¤å‘¢ï¼Ÿ</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Writer</code> è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Transmitter::Transmit()</code> å‡½æ•°</li>
  <li>è®¾ç½® <code class="language-plaintext highlighter-rouge">msg_info::seq_num = NextSeqNum</code> æ¶ˆæ¯çš„åºåˆ—å·</li>
  <li>åŠ å…¥ä¸€ä¸ª Transportäº‹ä»¶ï¼Œç±»å‹ä¸º Transmit Begin</li>
  <li>è°ƒç”¨å­ç±»å®ç°çš„ <code class="language-plaintext highlighter-rouge">Transmit()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°é€šè¿‡ä¼ å…¥ä¸€æ¡æ¶ˆæ¯å³å¯ä»¥å®Œæˆæ•°æ®å†™å…¥ä»»åŠ¡ã€‚</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M</span><span class="p">&gt;</span>
<span class="kt">bool</span> <span class="n">Transmitter</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;::</span><span class="n">Transmit</span><span class="p">(</span><span class="k">const</span> <span class="n">MessagePtr</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">msg_info_</span><span class="p">.</span><span class="n">set_seq_num</span><span class="p">(</span><span class="n">NextSeqNum</span><span class="p">());</span>
  <span class="n">PerfEventCache</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddTransportEvent</span><span class="p">(</span>
      <span class="n">TransPerf</span><span class="o">::</span><span class="n">TRANSMIT_BEGIN</span><span class="p">,</span> <span class="n">attr_</span><span class="p">.</span><span class="n">channel_id</span><span class="p">(),</span> <span class="n">msg_info_</span><span class="p">.</span><span class="n">seq_num</span><span class="p">());</span>
  <span class="k">return</span> <span class="n">Transmit</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_info_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¥½ï¼Œæˆ‘å¯¹ <code class="language-plaintext highlighter-rouge">Receiver</code> å’Œ <code class="language-plaintext highlighter-rouge">Transmitter</code> ç±»çš„ä»‹ç»å°±åˆ°è¿™é‡Œäº†ã€‚æˆ‘ä¸æ‰“ç®—å†ç»§ç»­ä»‹ç»å®ƒä»¬çš„å­ç±»ä»¥åŠæ›´åŠ åº•å±‚çš„è®¾è®¡æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå› ä¸ºè¿™è¾¹ç‰µæ‰¯åˆ°éå¸¸å¤šçš„æŠ€æœ¯ç»†èŠ‚ï¼Œå¼„æ‡‚è¿™äº›ä¼šæ¶ˆè€—éå¸¸å¤šçš„ç²¾åŠ›ï¼Œè€Œä¸”è¿™äº›ä¸œè¥¿ä¹Ÿè¿œè¿œè¶…å‡ºäº†è¯¾é¢˜ç»„ç›®å‰çš„è¦æ±‚ã€‚</p>

<h2 id="data-éƒ¨åˆ†">Data éƒ¨åˆ†</h2>

<p>é€šä¿¡æ¶æ„çš„å†…å®¹å·²ç»å…¨éƒ¨ä»‹ç»å®Œäº†ï¼ˆè‡³å°‘å¯¹äºå‘å¸ƒâ€”è®¢é˜…é€šä¿¡æ–¹å¼æ¥è¯´ï¼‰ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰ç¼ºäº†ä»€ä¹ˆä¸œè¥¿ï¼ŒæŠŠè¿™ä¸¤è€…æœ‰æ•ˆåœ°è¿æ¥èµ·æ¥ğŸ˜…ã€‚æ²¡é”™ï¼Œæˆ‘è‡³ä»Šè¿˜æ²¡æœ‰è¯´æ¸…æ¥šï¼Œ<code class="language-plaintext highlighter-rouge">Writer</code> å‘å¸ƒçš„æ¶ˆæ¯æ˜¯å¦‚ä½•è®© <code class="language-plaintext highlighter-rouge">Reader</code> çœ‹åˆ°çš„ã€‚è€Œè¿™å°±ç‰µæ‰¯åˆ° <code class="language-plaintext highlighter-rouge">cyber/data</code> ä¸­å®ç°çš„ç±»äº†ã€‚</p>

<h3 id="datavisitor">DataVisitor</h3>

<p>å…ˆæ¥è¯´è¯´æ•°æ®è®¿é—®ç±» <code class="language-plaintext highlighter-rouge">DataVisitor</code> ï¼Œå®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">DataVisitorBase</code> çš„å­ç±»ã€‚å®ƒçš„ä¸»è¦æˆå‘˜å’Œæ„é€ å‡½æ•°å¦‚ä¸‹ã€‚å…ˆæ¥è¯´å‡ ä¸ªæ˜æ˜¾å¯ä»¥å¾—åˆ°çš„ç»“è®ºï¼š</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">DataVisitor</code> å¯¹è±¡éƒ½ä¼šæœ‰è‹¥å¹²ä¸ªç¼“å­˜ç±» <code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ï¼Œè¿˜æœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DataFusion</code> å¯¹è±¡ï¼Œèåˆäº†æ‰€æœ‰çš„æ¶ˆæ¯ç±»å‹</li>
  <li>åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé¦–å…ˆæ„å»ºè¿™äº› <code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ï¼Œç„¶åå®ƒä»¬éƒ½ä¼šè¢«åŠ å…¥åˆ°<strong>ç›¸åº”ç±»å‹</strong>çš„ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> çš„ç®¡ç†ä¸­</li>
  <li>
<code class="language-plaintext highlighter-rouge">data_notifier_</code> ï¼ˆå­˜åœ¨äº <code class="language-plaintext highlighter-rouge">DataVisitorBase</code> ä¸­ï¼‰ï¼Œä¼šå‘ä¿¡é“ 0 åŠ å…¥ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">notifier_</code> ï¼Œç±»å‹ä¸º <code class="language-plaintext highlighter-rouge">struct Notifier { std::function&lt;void()&gt; callback; };</code>ï¼Œè¿™è¡¨æ˜ä¿¡é“ 0 æ³¨å®šä¸å…¶ä»–ä¿¡é“ä¸ä¸€èˆ¬ <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20">
</li>
  <li>
<code class="language-plaintext highlighter-rouge">data_fusion_</code> ä¼šæ„å»ºå¹¶æŒ‡å‘ <code class="language-plaintext highlighter-rouge">AllLatest</code> å¯¹è±¡ï¼Œä»ç±»å‹æ¥çœ‹ï¼Œå®ƒä»¬æ•´åˆäº†æ‰€æœ‰çš„æ¶ˆæ¯ç±»å‹ï¼Œåº”å½“ç”¨äºä¿¡æ¯çš„æœ€åæ”¶é›†å‘é€</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M0</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">M1</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">DataVisitor</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">NullType</span><span class="p">,</span> <span class="n">NullType</span><span class="o">&gt;</span> <span class="o">:</span> <span class="k">public</span> <span class="n">DataVisitorBase</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="k">explicit</span> <span class="n">DataVisitor</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">VisitorConfig</span><span class="o">&gt;&amp;</span> <span class="n">configs</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">buffer_m0_</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel_id</span><span class="p">,</span> <span class="k">new</span> <span class="n">BufferType</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">queue_size</span><span class="p">)),</span>
     <span class="n">buffer_m1_</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel_id</span><span class="p">,</span> <span class="k">new</span> <span class="n">BufferType</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">queue_size</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">DataDispatcher</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddBuffer</span><span class="p">(</span><span class="n">buffer_m0_</span><span class="p">);</span>
    <span class="n">DataDispatcher</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddBuffer</span><span class="p">(</span><span class="n">buffer_m1_</span><span class="p">);</span>
    <span class="n">data_notifier_</span><span class="o">-&gt;</span><span class="n">AddNotifier</span><span class="p">(</span><span class="n">buffer_m0_</span><span class="p">.</span><span class="n">channel_id</span><span class="p">(),</span> <span class="n">notifier_</span><span class="p">);</span>
    <span class="n">data_fusion_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">fusion</span><span class="o">::</span><span class="n">AllLatest</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer_m0_</span><span class="p">,</span> <span class="n">buffer_m1_</span><span class="p">);</span>
  <span class="p">}</span>
 <span class="nl">private:</span>
  <span class="n">fusion</span><span class="o">::</span><span class="n">DataFusion</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="o">&gt;*</span> <span class="n">data_fusion_</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;</span> <span class="n">buffer_m0_</span><span class="p">;</span>
  <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;</span> <span class="n">buffer_m1_</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/** DataVisitorBase å†…æœ‰
 * æŒ‡å‘ DataNotifier çš„æŒ‡é’ˆ
 * å°è£…ä¸º Notifier çš„å›è°ƒå‡½æ•°  */</span>
<span class="k">class</span> <span class="nc">DataVisitorBase</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="kt">void</span> <span class="n">RegisterNotifyCallback</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&amp;&amp;</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">notifier_</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="nl">protected:</span>
  <span class="kt">uint64_t</span> <span class="n">next_msg_index_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">DataNotifier</span><span class="o">*</span> <span class="n">data_notifier_</span> <span class="o">=</span> <span class="n">DataNotifier</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Notifier</span><span class="o">&gt;</span> <span class="n">notifier_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p><em>è¯¥ç±»ä¸»è¦ç”¨äºæ¶ˆæ¯æ•°æ®çš„è®¿é—®ï¼Œå­˜æ”¾åˆ°æ¥çš„æ¶ˆæ¯æ•°æ®ï¼Œå¹¶æä¾›æ¥å£ä¾›æ¶ˆæ¯è¯»å–</em>ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨è®¨è®º<a href="https://dingfen.github.io/apollo/2020/10/25/CyberComponent.html#%E7%9C%9F%E5%AE%9E%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%A8%A1%E6%8B%9F%E6%A8%A1%E5%BC%8F">ç»„ä»¶çš„åˆå§‹åŒ–çš„æœ€åéƒ¨åˆ†æ—¶</a>è§è¿‡å®ƒï¼Œä¹Ÿåœ¨<a href="https://dingfen.github.io/apollo/2020/11/03/CyberCommu1.html#reader-%E7%B1%BB">è®¢é˜…è€…åˆå§‹åŒ–æ—¶é‡è§è¿‡å®ƒ</a>ï¼Œä½†å½“æ—¶æˆ‘éƒ½æœ‰æ„åœ°ç•¥è¿‡äº†ã€‚ç°åœ¨æˆ‘ä»¬é‡æ‹¾è¿™éƒ¨åˆ†å†…å®¹ï¼ˆä¸ºäº†ç®€å•ä¸”ä¸å¤±ä¸€èˆ¬æ€§ï¼Œæˆ‘ä»¥ä¸¤ä¸ªä¿¡é“çš„æƒ…å†µä¸ºä¾‹ï¼‰ï¼ŒæŠŠè¿™éƒ¨åˆ†å½»åº•ææ˜ç™½ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M0</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">M1</span><span class="p">&gt;</span>
<span class="kt">bool</span> <span class="n">Component</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">NullType</span><span class="p">,</span> <span class="n">NullType</span><span class="o">&gt;::</span><span class="n">Initialize</span><span class="p">()</span> <span class="p">{</span>
   <span class="cm">/*   ....   */</span>
  <span class="c1">// åˆ›å»º DataVisitor å’Œ RoutineFactory   æœ€ååˆ›å»ºä»»åŠ¡</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">data</span><span class="o">::</span><span class="n">VisitorConfig</span><span class="o">&gt;</span> <span class="n">config_list</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">reader</span> <span class="o">:</span> <span class="n">readers_</span><span class="p">)</span>
    <span class="n">config_list</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">reader</span><span class="o">-&gt;</span><span class="n">ChannelId</span><span class="p">(),</span> <span class="n">reader</span><span class="o">-&gt;</span><span class="n">PendingQueueSize</span><span class="p">());</span>
   <span class="c1">// åˆ›å»ºäº†ä¸¤ä¸ªä¿¡é“çš„ DataVisitor å¹¶ç”¨åœ¨äº†åç¨‹å·¥å‚ç±»</span>
  <span class="k">auto</span> <span class="n">dv</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">data</span><span class="o">::</span><span class="n">DataVisitor</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">config_list</span><span class="p">);</span>
  <span class="n">croutine</span><span class="o">::</span><span class="n">RoutineFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">croutine</span><span class="o">::</span><span class="n">CreateRoutineFactory</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">dv</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">sched</span><span class="o">-&gt;</span><span class="n">CreateTask</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">node_</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç åšäº†ï¼š</p>

<ul>
  <li>
    <p>æ”¶é›†äº†æ‰€æœ‰çš„ <code class="language-plaintext highlighter-rouge">Reader</code> å¯¹è±¡çš„æ‰€è¯»ä¿¡é“ id å’Œæ¶ˆæ¯é˜Ÿåˆ—å¤§å°ï¼Œæ”¾å…¥åˆ° <code class="language-plaintext highlighter-rouge">config_list</code> åå°±åˆ›å»º <code class="language-plaintext highlighter-rouge">DataVisitor</code> å¯¹è±¡</p>
  </li>
  <li>
    <p>åœ¨ä¸Šé¢ <code class="language-plaintext highlighter-rouge">DataVisitor</code> ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæ ¹æ®ä¼ å…¥çš„ä¿¡é“ id å’Œæ¶ˆæ¯é˜Ÿåˆ—å°ºå¯¸ï¼Œ<code class="language-plaintext highlighter-rouge">DataVisitor</code> å†…ä¸ºå…¶åˆ›å»ºäº†ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ä½œä¸ºç¼“å†²åŒº</p>

    <ul>
      <li>è°ƒç”¨æ•°æ®åˆ†å‘å™¨å°†å®ƒä»¬åŠ å…¥åˆ° <code class="language-plaintext highlighter-rouge">DataDispatcher</code> çš„ç®¡ç†ä¸­</li>
      <li>è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DataNotifier::AddNotifier()</code> å‡½æ•°ï¼Œä¼ å…¥ç¬¬ 0 ä¸ªè¯»è€…çš„ä¿¡é“ id ï¼ŒåŠ å…¥åˆ° <code class="language-plaintext highlighter-rouge">DataNotifier</code> çš„ç®¡ç†ä¸­ã€‚<code class="language-plaintext highlighter-rouge">DataDispatcher</code> ä¸ <code class="language-plaintext highlighter-rouge">DataNotifier</code> ç±»å‡ä¸ºå•ä¾‹ï¼Œä¹‹åæˆ‘ä»¬ä¼šå¯¹å®ƒä»¬åšè¯¦ç»†ä»‹ç»</li>
      <li>åˆ›å»º <code class="language-plaintext highlighter-rouge">DataFusion</code> å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹åè¦äº†è§£çš„â•®(â•¯â–½â•°)â•­</li>
    </ul>
  </li>
  <li>
    <p>åˆ›å»ºåç¨‹å·¥å‚ï¼Œå¹¶æ„å»ºå‡ºè¦å°è£…ä¸ºåç¨‹çš„å‡½æ•°ï¼š</p>

    <div class="language-c++ highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="n">factory</span><span class="p">.</span><span class="n">create_routine</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="o">=</span><span class="p">]()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;</span> <span class="n">msg0</span><span class="p">;</span>     <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;</span> <span class="n">msg1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
      <span class="n">CRoutine</span><span class="o">::</span><span class="n">GetCurrentRoutine</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">RoutineState</span><span class="o">::</span><span class="n">DATA_WAIT</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dv</span><span class="o">-&gt;</span><span class="n">TryFetch</span><span class="p">(</span><span class="n">msg0</span><span class="p">,</span> <span class="n">msg1</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// å–æ•°æ®</span>
        <span class="n">f</span><span class="p">(</span><span class="n">msg0</span><span class="p">,</span> <span class="n">msg1</span><span class="p">);</span>	<span class="c1">// f å‡½æ•°å°±æ˜¯ç»„ä»¶åˆå§‹åŒ–æ—¶åˆ›å»ºçš„ func å‡½æ•°</span>
        <span class="n">CRoutine</span><span class="o">::</span><span class="n">Yield</span><span class="p">(</span><span class="n">RoutineState</span><span class="o">::</span><span class="n">READY</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span>
        <span class="n">CRoutine</span><span class="o">::</span><span class="n">Yield</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span> <span class="p">};</span>
</code></pre></div>    </div>

    <p>åç¨‹åšçš„å°±æ˜¯è°ƒç”¨ <code class="language-plaintext highlighter-rouge">dv-&gt;TryFetch()</code> å–æ•°æ®ï¼ˆä¸‹æ–‡ä¼šè¯¦ç»†è¯´æ˜ï¼‰ï¼Œå¦‚æœæˆåŠŸå°±è°ƒç”¨ç»„ä»¶çš„ <code class="language-plaintext highlighter-rouge">Process()</code> å‡½æ•°ï¼Œä¸”åç¨‹çš„çŠ¶æ€ä»ç­‰å¾…æ•°æ®è½¬å˜ä¸ºäº†å°±ç»ªï¼Œè€Œä¸€æ—¦åç¨‹å°±ç»ªï¼Œå°±å¯ä»¥è¢« <code class="language-plaintext highlighter-rouge">Processor</code> ç±»è¿è¡Œ</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Scheduler</code> åˆ›å»ºä»»åŠ¡ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">CreateTask()</code> å‡½æ•°ä¸­ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">visitor-&gt;RegisterNotifyCallback()</code> å‡½æ•°</p>

    <div class="language-c++ highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="n">visitor</span><span class="o">-&gt;</span><span class="n">RegisterNotifyCallback</span><span class="p">([</span><span class="k">this</span><span class="p">,</span> <span class="n">task_id</span><span class="p">]()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cyber_unlikely</span><span class="p">(</span><span class="n">stop_</span><span class="p">.</span><span class="n">load</span><span class="p">()))</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">NotifyProcessor</span><span class="p">(</span><span class="n">task_id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div>    </div>

    <p>ä¸Šé¢çš„å‡½æ•°è¢«èµ‹å€¼ç»™äº† <code class="language-plaintext highlighter-rouge">DataVisitorBase::notifier_</code> ï¼Œç”¨äºå”¤é†’ç›¸åº”çš„åç¨‹æ¥å¤„ç†è¯¥æ–°æ¶ˆæ¯</p>
  </li>
</ul>

<p>è¯´å®Œè¿™éƒ¨åˆ†è¿‡ç¨‹åï¼Œæˆ‘å‘ç°æˆ‘ä»¬è‡³å°‘è¿˜è¦ç†è§£ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> ã€ <code class="language-plaintext highlighter-rouge">DataNotifier</code> ã€ <code class="language-plaintext highlighter-rouge">DataFusion</code> å’Œ <code class="language-plaintext highlighter-rouge">AllLatest</code> ç±»ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚</p>

<h3 id="datadispatcher">DataDispatcher</h3>

<p>åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚å…ˆæ¥çœ‹çœ‹æ•°æ®åˆ†å‘ç±» <code class="language-plaintext highlighter-rouge">DataDispatcher</code> ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒå°†åº•å±‚ä¼ æ¥çš„æ•°æ®è¿›è¡Œåˆ†å‘ï¼Œå…·ä½“æ¥è¯´ï¼Œå½“æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">Dispatch()</code> å‡½æ•°æŠŠå®ƒä»¬æ”¾åˆ°è¯¥ä¿¡é“ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯ç¼“å†²åŒºä¸­ã€‚å®ƒæ˜¯ä¸ªå•ä¾‹æ¨¡å¼ï¼Œä½†æ˜¯ä¸ªæ¨¡æ¿ç±»ï¼Œæ„å‘³ç€æ¯ä¸€ä¸ªæ¶ˆæ¯ç±»å‹ä¼šæœ‰å¯¹åº”çš„ä¸€ä¸ªå”¯ä¸€çš„ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> å¯¹è±¡ã€‚ç±»å†…è®°å½•äº†ä¸€ä¸ªä¿¡é“ id ä¸å¤šä¸ª <code class="language-plaintext highlighter-rouge">CacheBuffer</code> å¯¹è±¡å¯¹åº”çš„è¡¨ã€‚æ³¨æ„åˆ°ï¼šä¸€ä¸ªä¿¡é“å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€… <code class="language-plaintext highlighter-rouge">Reader</code> ï¼Œæ¯ä¸ªè®¢é˜…è€…æ‹¥æœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">CacheBuffer</code> ç¼“å†²åŒºï¼Œè€Œè¿™ä¸ªç¼“å†²åŒºå°±æ˜¯ä¹‹å‰ <code class="language-plaintext highlighter-rouge">DataVisitor</code> ç±»åœ¨æ„é€ æ—¶ç»™æ¯ä¸ªæ¶ˆæ¯ç±»å‹åˆ›å»ºçš„ <code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">DataDispatcher</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="kt">void</span> <span class="n">AddBuffer</span><span class="p">(</span><span class="k">const</span> <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">channel_buffer</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">Dispatch</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">channel_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">msg</span><span class="p">);</span>
 <span class="nl">private:</span>
  <span class="n">DataNotifier</span><span class="o">*</span> <span class="n">notifier_</span> <span class="o">=</span> <span class="n">DataNotifier</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span>
  <span class="n">AtomicHashMap</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">BufferVector</span><span class="o">&gt;</span> <span class="n">buffers_map_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">bool</span> <span class="n">DataDispatcher</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Dispatch</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">channel_id</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BufferVector</span><span class="o">*</span> <span class="n">buffers</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">apollo</span><span class="o">::</span><span class="n">cyber</span><span class="o">::</span><span class="n">IsShutdown</span><span class="p">())</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="c1">// æ¯æ¬¡æ”¶åˆ°è¯¥ä¿¡é“çš„æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šç»™æ‰€æœ‰ç¼“å†²åŒºéƒ½æ”¾ä¸€ä»½æ¶ˆæ¯</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buffers_map_</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffers</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">buffer_wptr</span> <span class="o">:</span> <span class="o">*</span><span class="n">buffers</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_wptr</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Mutex</span><span class="p">());</span>
       <span class="c1">// å‘ CacheBuffer å¡«å…¥æ•°æ®</span>
        <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Fill</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">notifier_</span><span class="o">-&gt;</span><span class="n">Notify</span><span class="p">(</span><span class="n">channel_id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">DataDispatcher::Dispatch()</code> å‡½æ•°éå¸¸é‡è¦ï¼Œåœ¨ <a href="#1">ReceiverManager</a> å’Œ <a href="#2">Receiver &amp;&amp; Transmitter</a> ä¸­æˆ‘ä»¬å·²ç»æåˆ°ï¼Œä»–æ˜¯è¿æ¥ä¸Šå±‚å’Œåº•å±‚çš„æœ€å…³é”®ä¸€ç¯ã€‚åœ¨ <code class="language-plaintext highlighter-rouge">Receiver</code> å¯¹è±¡æ¯æ¬¡æ”¶åˆ°è¯¥ä¿¡é“çš„æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">DataDispatcher::Dispatch()</code> å‡½æ•°åˆ†å‘åˆšæ”¶åˆ°çš„æ•°æ®ï¼Œå‡½æ•°ä¼šå…ˆä»è¡¨ä¸­å–å‡ºæ‰€æœ‰å¯¹åº”ä¿¡é“çš„ç¼“å†²åŒºï¼Œç„¶åè°ƒç”¨ <code class="language-plaintext highlighter-rouge">CacheBuffer::Fill()</code> å‡½æ•°æ¥ç»™ç¼“å†²åŒºå¡«æ•°æ®ï¼ˆç¨åä»‹ç»è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œæœ€åè°ƒç”¨ <code class="language-plaintext highlighter-rouge">DataNotifier::Notify()</code> å‡½æ•°ï¼Œå”¤é†’å®ƒä»¬å¯¹åº”çš„åç¨‹æ¥å–æ•°æ®å¹¶è¿è¡Œã€‚ç°åœ¨ä½ åº”è¯¥æ˜ç™½ï¼Œä¸ºä½• <code class="language-plaintext highlighter-rouge">DataVisitor</code> åœ¨æ„é€ æ—¶ï¼Œéœ€è¦æŠŠåˆšåˆšå»ºç«‹çš„ç¼“å†²åŒºç»™ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> ç®¡ç†ï¼Œä¸ç„¶çš„è¯ï¼Œç¼“å†²åŒºæ‹¿ä¸åˆ°æ¶ˆæ¯å•Šã€‚</p>

<h3 id="datanotifier">DataNotifier</h3>

<p>å†æ¥çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">DataNotifier</code> ç±»ã€‚å®ƒæ˜¯ä¸ªå•ä¾‹æ¨¡å¼ï¼Œç±»å†…æœ‰ä¸€ä¸ªä¿¡é“ id ä¸å¤šä¸ª <code class="language-plaintext highlighter-rouge">Notifer</code> å¯¹åº”çš„è¡¨ï¼Œè¿™æ˜¯è€ƒè™‘åˆ°ä¸€ä¸ªä¿¡é“å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…ã€‚å¾ˆæ˜¾ç„¶ï¼Œå‰æ–‡æåˆ°çš„åœ¨ <code class="language-plaintext highlighter-rouge">DataVisitor</code> æ„é€ æ—¶ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">AddNotifier()</code> å°±æ˜¯è¦æŠŠè‡ªå·±çš„ <code class="language-plaintext highlighter-rouge">Notifier</code> å­˜åˆ°è¿™ä¸ªè¡¨ä¸­ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DataNotifier</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="kt">void</span> <span class="n">AddNotifier</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">channel_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Notifier</span><span class="o">&gt;&amp;</span> <span class="n">notifier</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">Notify</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">channel_id</span><span class="p">);</span>
 <span class="nl">private:</span>
  <span class="n">AtomicHashMap</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">NotifyVector</span><span class="o">&gt;</span> <span class="n">notifies_map_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è‡³äº <code class="language-plaintext highlighter-rouge">AddNotifier()</code> å‡½æ•°çš„å®ç°ï¼Œemmâ€¦â€¦å¾ˆå¹³å‡¡ï¼Œæ— éå°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„ä¿¡é“ id ï¼Œç„¶åå°†å‚æ•°ä¸­çš„ <code class="language-plaintext highlighter-rouge">Notifier</code> æ”¾å…¥åˆ°æ•°ç»„é‡Œï¼ˆå¦‚æœæ²¡æœ‰æ•°ç»„ï¼Œæ–°å»ºä¸€ä¸ªï¼‰ã€‚é‡è¦çš„æ˜¯å”¤é†’å‡½æ•° <code class="language-plaintext highlighter-rouge">Notify()</code> ï¼Œè¯¥å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">notifier-&gt;callback()</code> ï¼Œå›é¡¾ä¸€ä¸‹ï¼Œè¿™ä¸ª <code class="language-plaintext highlighter-rouge">notifier</code> æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">Scheduler</code> åˆ›å»ºä»»åŠ¡æ—¶è¢«è®¾ç½®çš„ï¼Œå†…å«æœ‰ <code class="language-plaintext highlighter-rouge">NotifyProcessor()</code> å‡½æ•°ï¼Œå¯ä»¥å”¤é†’åç¨‹ã€‚åœ¨ <a href="#2">Receiver &amp;&amp; Transmitter</a> å’Œ <a href="#1">ReceiverManager</a> ä¹Ÿæåˆ°ï¼Œç¬¬äºŒæ­¥çš„åˆ†å‘å™¨æœ€ç»ˆä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå”¤é†’æ‰€æœ‰ç›‘å¬è¯¥ä¿¡é“çš„åç¨‹ï¼Œæ¥å¤„ç†åˆ°æ¥çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä½ ä¹Ÿå°±æ˜ç™½ä¸ºä»€ä¹ˆ <code class="language-plaintext highlighter-rouge">DataVisitor</code> ç±»åœ¨æ„é€ æ—¶è¦æŠŠ <code class="language-plaintext highlighter-rouge">notifier</code> åŠ å…¥è¿›å»äº†ï¼Œä¸ç„¶çš„è¯ä¿¡é“æ¥äº†ä¸ªæ¶ˆæ¯ï¼Œå°±æ²¡æ³•å”¤é†’åç¨‹ï¼Œ<code class="language-plaintext highlighter-rouge">Reader</code> å°±ä¸çŸ¥é“äº†å‘€ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="kt">bool</span> <span class="n">DataNotifier</span><span class="o">::</span><span class="n">Notify</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">channel_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NotifyVector</span><span class="o">*</span> <span class="n">notifies</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">notifies_map_</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notifies</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">notifier</span> <span class="o">:</span> <span class="o">*</span><span class="n">notifies</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">notifier</span> <span class="o">&amp;&amp;</span> <span class="n">notifier</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span>
        <span class="n">notifier</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">();</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="datafusion--alllatest">DataFusion &amp; AllLatest</h3>

<p>å†æ¥çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">DataVisitor</code> æ„é€ å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œåˆ›å»º <code class="language-plaintext highlighter-rouge">DataFusion</code> å¯¹è±¡ï¼Œçœ‹çœ‹åå­—ï¼Œå°±åº”è¯¥æ˜ç™½è¯¥å¯¹è±¡ç”¨äºä¿¡é“æ•°æ®çš„èåˆã€‚<code class="language-plaintext highlighter-rouge">DataFusion</code> æ˜¯ <code class="language-plaintext highlighter-rouge">AllLatest</code> çš„åŸºç±»ï¼Œ<code class="language-plaintext highlighter-rouge">DataFusion</code> ç±»ååˆ†ç®€å•ï¼Œä»…æä¾›äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Fusion()</code> æ¥å£ï¼Œå…·ä½“ç”± <code class="language-plaintext highlighter-rouge">AllLatest</code> å®ç°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹ <code class="language-plaintext highlighter-rouge">AllLatest</code> ç±»ï¼Œå“ˆï¼Œå¬åå­—å°±çŸ¥é“å®ƒä¼šå–æ‰€æœ‰ä¿¡é“ä¸­çš„<strong>æœ€æ–°å€¼</strong>ï¼Œå†ç»“åˆå®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">DataFusion</code> çš„å­ç±»ï¼Œæ‰€ä»¥ä¸»è¦åŠŸèƒ½åº”è¯¥æ˜¯<strong>èåˆå¤šä¸ªä¿¡é“çš„æœ€æ–°æ•°æ®</strong>ã€‚</p>

<p>æˆ‘è¿˜æ˜¯ä»¥ä¸¤ä¸ªä¿¡é“çš„æƒ…å†µä¸ºä¾‹ï¼Œè¯¥ç±»æˆå‘˜æœ‰å‡ ä¸ª <code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ç±»ï¼Œå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šï¼Œç±»å‹æ˜¯æ•°æ®èåˆçš„ <code class="language-plaintext highlighter-rouge">buffer_fusion_</code> ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">M0</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">M1</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">AllLatest</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">NullType</span><span class="p">,</span> <span class="n">NullType</span><span class="o">&gt;</span> <span class="o">:</span> <span class="k">public</span> <span class="n">DataFusion</span><span class="o">&lt;</span><span class="n">M0</span><span class="p">,</span> <span class="n">M1</span><span class="o">&gt;</span> <span class="p">{</span>
     <span class="c1">// æ‰€è°“èåˆæ¶ˆæ¯ï¼Œå°±æ˜¯æ”¾åœ¨ tuple é‡Œ</span>
 <span class="k">using</span> <span class="n">FusionDataType</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;&gt;</span><span class="p">;</span>
 <span class="nl">private:</span>
  <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;</span> <span class="n">buffer_m0_</span><span class="p">;</span>
  <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;</span> <span class="n">buffer_m1_</span><span class="p">;</span>
  <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">FusionDataType</span><span class="o">&gt;</span> <span class="n">buffer_fusion_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œç‰¹æ®Šçš„ä¿¡é“ 0 çš„æ¶ˆæ¯ç¼“å†²åŒºä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">SetFusionCallback()</code> æ¥è®¾ç½®<strong>å›è°ƒå‡½æ•°</strong> <img class="emoji" title=":point_down:" alt=":point_down:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f447.png" height="20" width="20">ï¼Œ<em>ä¸ºæ–¹ä¾¿è¡¨è¿°ï¼Œæˆ‘ç»™å®ƒèµ·å <code class="language-plaintext highlighter-rouge">FusionFunc</code></em> ã€‚ä»ä¸‹é¢çš„ä»£ç ä¸­çœ‹å‡ºï¼Œ <code class="language-plaintext highlighter-rouge">FusionFunc</code> å…ˆåˆ¤æ–­æ˜¯å¦æ‰€æœ‰ä¿¡é“éƒ½æœ‰æ¶ˆæ¯ï¼Œå¹¶è·å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœéƒ½æœ‰æ¶ˆæ¯çš„è¯å°±å°†è¿™äº›æ¶ˆæ¯èåˆï¼Œå³ç”¨ <code class="language-plaintext highlighter-rouge">std::tuple</code> å°è£…ï¼Œå†è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Fill()</code> å‡½æ•°å¡«å…¥åˆ° <code class="language-plaintext highlighter-rouge">buffer_fusion_</code> çš„ <code class="language-plaintext highlighter-rouge">CacheBuffer</code> ä¸­ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AllLatest</span><span class="p">(</span><span class="k">const</span> <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;&amp;</span> <span class="n">buffer_0</span><span class="p">,</span> <span class="k">const</span> <span class="n">ChannelBuffer</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;&amp;</span> <span class="n">buffer_1</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">buffer_m0_</span><span class="p">(</span><span class="n">buffer_0</span><span class="p">),</span> <span class="n">buffer_m1_</span><span class="p">(</span><span class="n">buffer_1</span><span class="p">),</span>
        <span class="n">buffer_fusion_</span><span class="p">(</span><span class="n">buffer_m0_</span><span class="p">.</span><span class="n">channel_id</span><span class="p">(),</span>
           <span class="k">new</span> <span class="n">CacheBuffer</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FusionDataType</span><span class="o">&gt;&gt;</span><span class="p">(</span>
              <span class="n">buffer_0</span><span class="p">.</span><span class="n">Buffer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Capacity</span><span class="p">()</span> <span class="o">-</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">buffer_m0_</span><span class="p">.</span><span class="n">Buffer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetFusionCallback</span><span class="p">(</span> <span class="c1">// buffer0 è®¾ç½®èåˆçš„å›è°ƒå‡½æ•°</span>
        <span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;&amp;</span> <span class="n">m0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;</span> <span class="n">m1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_m1_</span><span class="p">.</span><span class="n">Latest</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span> <span class="c1">// ä¿¡é“å†…æ˜¯å¦æœ‰æ¶ˆæ¯ æœ‰çš„è¯å–å‡ºæœ€åä¸€ä¸ª</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="k">auto</span> <span class="n">data</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">FusionDataType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">);</span>
          <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lg</span><span class="p">(</span><span class="n">buffer_fusion_</span><span class="p">.</span><span class="n">Buffer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Mutex</span><span class="p">());</span>
          <span class="c1">// å¡«å……åˆ°æ¶ˆæ¯ä¸­</span>
          <span class="n">buffer_fusion_</span><span class="p">.</span><span class="n">Buffer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Fill</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><strong>ä½•æ—¶è°ƒç”¨</strong> <code class="language-plaintext highlighter-rouge">FusionFunc</code> å‘¢ï¼Ÿç­”æ¡ˆåœ¨è¿™ä¸ª <code class="language-plaintext highlighter-rouge">Fill()</code> å‡½æ•°ï¼ˆè§ä¸‹ä»£ç ï¼‰ä¸­ï¼Œå®ƒè¯¡è®¡å¤šç«¯â€”â€”å¦‚æœ <code class="language-plaintext highlighter-rouge">CacheBuffer</code> æœ‰å›è°ƒå‡½æ•° <code class="language-plaintext highlighter-rouge">FusionFunc</code>ï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼›å¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ¥æ”¶åˆ°çš„æ•°æ®æ”¾å…¥ç¼“å†²åŒºä¸­ã€‚å¾ˆæ˜¾ç„¶åœ¨ä¸Šé¢çš„æ„é€ å‡½æ•°ä¸­ï¼Œåªæœ‰ä¿¡é“ 0 è®¾ç½®äº†å›è°ƒå‡½æ•° <code class="language-plaintext highlighter-rouge">FusionFunc</code>ã€‚<em>å› æ­¤å½“ä¿¡é“ 0 æœ‰æ•°æ®åˆ°æ¥ï¼Œ <code class="language-plaintext highlighter-rouge">DataDispatcher::Dispatch()</code> è¢«è°ƒç”¨æ—¶ï¼ˆä»£ç è§ DataDispatcher éƒ¨åˆ†ï¼‰ï¼Œè¿›è€Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">Fill()</code> å‡½æ•°æ—¶ï¼Œ <code class="language-plaintext highlighter-rouge">FusionFunc</code> æ‰ä¼šè¢«è°ƒç”¨</em>ï¼Œå°†æœ€æ–°çš„æ¶ˆæ¯èåˆï¼Œå¹¶å°†èåˆçš„æ¶ˆæ¯å¡«å…¥åˆ° <code class="language-plaintext highlighter-rouge">buffer_fusion_</code> ä¸­ã€‚è€Œå…¶ä»–ä¿¡é“çš„æ•°æ®åˆ°æ¥æ—¶ï¼Œ <code class="language-plaintext highlighter-rouge">Fill()</code> å‡½æ•°åªæ˜¯å•çº¯å¾€å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">CacheBuffer</code> ä¸­å¡«æ•°æ®ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="n">CacheBuffer</span><span class="o">::</span><span class="n">Fill</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fusion_callback_</span><span class="p">)</span>
      <span class="n">fusion_callback_</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>  <span class="c1">// buffer 0 è¿è¡Œè¿™ä¸ª</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Full</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">buffer_</span><span class="p">[</span><span class="n">GetIndex</span><span class="p">(</span><span class="n">head_</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="o">++</span><span class="n">head_</span><span class="p">;</span>     <span class="o">++</span><span class="n">tail_</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">buffer_</span><span class="p">[</span><span class="n">GetIndex</span><span class="p">(</span><span class="n">tail_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="o">++</span><span class="n">tail_</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>åœ¨åç¨‹çš„å¤„ç†å‡½æ•°ä¸­ï¼ˆå›é¡¾ä¸€ä¸‹ï¼Œ DataVisitor çš„åˆ›å»ºåç¨‹å·¥å‚ä¸­æåˆ°çš„ï¼‰ä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">DataVisitor::TryFetch()</code> å‡½æ•°ï¼Œå†è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Fusion()</code> å‡½æ•°ï¼ˆä»£ç å¦‚ä¸‹ï¼‰ï¼Œå®ƒä»èåˆæ•°æ®çš„ç¼“å†²åŒº <code class="language-plaintext highlighter-rouge">buffer_fusion_</code> ä¸­æ‹¿èµ°ï¼ˆFetchï¼‰èåˆæ¶ˆæ¯ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åŒæ—¶æ‹¿å¤šä¸ªä¿¡é“ä¸Šçš„æœ€æ–°æ¶ˆæ¯ï¼Œä¿è¯äº†æ¯æ¬¡ç»™ <code class="language-plaintext highlighter-rouge">Component::Process()</code> å‡½æ•°çš„å‚æ•°éƒ½å¿…é¡»â€œå…¨å‘˜åˆ°é½â€ï¼Œå¹¶ä¸”æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯æœ€æ–°çš„ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œåªæœ‰ä¿¡é“ 0 æ”¶åˆ°æ¶ˆæ¯åï¼Œæ‰ä¼šèåˆå…¶ä»–ä¿¡é“çš„æ¶ˆæ¯ï¼Œå¾€å¾€ä¸»å¯¼é€šä¿¡å¤„ç†çš„èŠ‚å¥ï¼Œå› æ­¤ä¿¡é“ 0 çš„é€‰å–å°±æ¯”è¾ƒå…³é”®äº†ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">DataVisitor</span><span class="o">::</span><span class="n">TryFetch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;&amp;</span> <span class="n">m0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;&amp;</span> <span class="n">m1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data_fusion_</span><span class="o">-&gt;</span><span class="n">Fusion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next_msg_index_</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">next_msg_index_</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">AllLatest</span><span class="o">::</span><span class="n">Fusion</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M0</span><span class="o">&gt;&amp;</span> <span class="n">m0</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">M1</span><span class="o">&gt;&amp;</span> <span class="n">m1</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FusionDataType</span><span class="o">&gt;</span> <span class="n">fusion_data</span><span class="p">;</span>
  <span class="c1">// ä» fusion ç¼“å†²åŒºä¸­å–æ•°æ®</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_fusion_</span><span class="p">.</span><span class="n">Fetch</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fusion_data</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="c1">// å¾—åˆ°äº†æ•°æ® åˆ†åˆ«èµ‹å€¼ç»™ m0 m1</span>
  <span class="n">m0</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">fusion_data</span><span class="p">);</span>
  <span class="n">m1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">fusion_data</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="channelbuffer--cachebuffer">ChannelBuffer &amp; CacheBuffer</h3>

<p>å‰æ–‡æˆ‘ä¸€ç›´æåˆ°ä¸€ä¸ªè¯ï¼Œå«åšç¼“å†²åŒºã€‚äº‹å®ä¸Šè¿™ä¸ªè¯å…·ä½“æŒ‡å‘äº†ä¸¤ä¸ªç±»ï¼Œ<code class="language-plaintext highlighter-rouge">ChannelBuffer</code> å’Œ <code class="language-plaintext highlighter-rouge">CacheBuffer</code> ç±»ã€‚ä¸ºäº†è®©è¯»è€…æ›´å¥½åœ°ç†è§£â€œç¼“å†²åŒºâ€è¿™ä¸ªè¯ï¼Œæˆ‘ç®€è¦åœ°ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªç±»ã€‚<code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ç±»åŒ…å«äº†ä¸¤ä¸ªæˆå‘˜ï¼šä¿¡é“ id å’Œ æŒ‡å‘ <code class="language-plaintext highlighter-rouge">CacheBuffer</code> çš„æŒ‡é’ˆã€‚å®ƒçš„å‡½æ•° <code class="language-plaintext highlighter-rouge">Fetch()</code> å’Œ <code class="language-plaintext highlighter-rouge">Latest()</code> åˆ†åˆ«ç”¨äºå–å¯¹åº”ç´¢å¼•çš„æ¶ˆæ¯å’Œå–å¾—æœ€æ–°æ¶ˆæ¯ã€‚è€Œ <code class="language-plaintext highlighter-rouge">CacheBuffer</code> ç±»ï¼Œå…¶å®è´¨å°±æ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œç”¨æ¥æ”¾ç½®æŸä¸ªä¿¡é“äº§ç”Ÿçš„æ•°æ®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">CacheBuffer</code> å ç”¨çš„å†…å­˜æ˜¯æ’å®šçš„ï¼Œå› ä¸ºé‡Œé¢çš„æ•°ç»„é•¿åº¦ä¸€å¼€å§‹å°±è¢«é™å®šäº†ï¼Œæ‰€ä»¥ï¼Œä¸€æ—¦ç¼“å†²åŒºè£…æ»¡äº†ï¼Œå®ƒä¼šæ¯«ä¸çŠ¹è±«åœ°ä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯ï¼Œæ¨å…¥æœ€æ–°çš„æ¶ˆæ¯ã€‚å…·ä½“çš„é˜Ÿåˆ—å®ç°åœ¨ <code class="language-plaintext highlighter-rouge">cyber/data/cache_buffer.h</code> å’Œ <code class="language-plaintext highlighter-rouge">cyber/data/channel_buffer.h</code>ï¼Œå¾ˆç®€å•ï¼Œæœ‰å…´è¶£å¯ä»¥ç›´æ¥è¯»ä»£ç ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>(âŠ™oâŠ™)å“¦ç»ˆäºï¼Œæˆ‘æŠŠ Cyber RT æ‰€æœ‰çš„é€šä¿¡æœºåˆ¶éƒ½çœ‹å®Œäº†ï¼Œå“¦ï¼ŒBTWï¼Œä¸Šç¯‡é€šä¿¡é“¾æ¥åœ¨<a href="https://dingfen.github.io/apollo/2020/11/03/CyberCommu1.html">è¿™é‡Œ</a>ã€‚ç°åœ¨ï¼Œåœ¨æŠŠæ‰€æœ‰çš„å†…å®¹éƒ½ææ˜ç™½åï¼Œè®©æˆ‘ä»¬ç†ä¸€ç†è‡ªå·±æ˜æ²‰çš„å¤´è„‘ï¼Œè·³è„±å‡ºä»£ç çš„è¾¹è¾¹æ¡†æ¡†ï¼Œä»ä¸Šå¸è§†è§’å®¡è§†ä¸€ä¸‹æ•°æ®æ˜¯å¦‚ä½•æµé€šçš„ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸¤å¼ éå¸¸å¥½çš„å›¾ï¼Œæ„Ÿè°¢ [2]ï¼Œæˆ‘å¯ä»¥ä¸ç”¨è‡ªå·±åŠ¨æ‰‹ï¼ŒèŠ±è´¹æ•°å°æ—¶ç”»å›¾äº†ğŸ˜€</p>

<p><img src="/assets/img/msg.png" alt=""></p>

<p>åœ¨ä¸Šé¢è¿™å¼ å›¾ä¸­ï¼Œä»ç„¶ä»¥ä¸¤ä¸ªä¿¡é“çš„ <code class="language-plaintext highlighter-rouge">Component</code> ä¸ºä¾‹ï¼Œä»å·¦ä¸Šè§’å‡ºå‘ï¼š</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Component</code> åˆå§‹åŒ–å»ºæˆäº†ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">Reader</code> å¯¹è±¡ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DataVisitor&lt;M0, M1&gt;</code> å¯¹è±¡</li>
  <li>ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">Reader</code> å¯¹è±¡ä¹Ÿåˆ†åˆ«åˆ›å»ºäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DataVisitor&lt;&gt;</code> å¯¹è±¡ï¼Œå›é¡¾ä¸€ä¸‹ä¸Šç¯‡æåˆ°çš„ <code class="language-plaintext highlighter-rouge">Reader</code> çš„åˆå§‹åŒ–è¿‡ç¨‹</li>
  <li>è¿™äº› <code class="language-plaintext highlighter-rouge">DataVisitor</code> å¯¹è±¡ä¼šåˆ†åˆ«åˆ›å»ºå‡º <code class="language-plaintext highlighter-rouge">ChannelBuffer</code> ï¼Œå¹¶ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> ç®¡ç†è¿™äº›ç¼“å†²åŒºï¼ˆæ³¨æ„çœ‹å®ƒå†…éƒ¨çš„è¡¨ï¼‰</li>
  <li>å½“æ¥æ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œ<code class="language-plaintext highlighter-rouge">DataDispatcher</code> ä¼šç»™å¯¹åº”çš„ä¿¡é“ä¸Šçš„æ‰€æœ‰ç¼“å†²åŒºè¿›è¡Œåˆ†æ´¾ï¼Œç‰¹åˆ«åœ°ï¼Œè‹¥ä¿¡é“ 0 æœ‰æ–°æ¶ˆæ¯ï¼Œè¿˜ä¼šå¯¹å…¶ä»–æ¶ˆæ¯è¿›è¡Œèåˆï¼ˆæ³¨æ„çœ‹ <code class="language-plaintext highlighter-rouge">AllLatest</code> å¯¹è±¡ï¼‰</li>
  <li>ä¹‹åï¼Œ<code class="language-plaintext highlighter-rouge">DataVisitor</code> ä¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DataNotifier</code> å¯¹è±¡ï¼Œå”¤é†’ç›¸åº”çš„åç¨‹ï¼Œå¤„ç†æ”¶åˆ°çš„æ•°æ®</li>
</ul>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹åº•å±‚çš„é€šä¿¡æ¶æ„ï¼Œè™½ç„¶æœ‰äº›éƒ¨åˆ†æˆ‘ç•¥å»æœªè®²ï¼Œä½†è¿™å¼ å›¾æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥çœ‹æ˜ç™½çš„ğŸ¶ã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬ä»æœ€å³è¾¹å¼€å§‹çœ‹èµ·ã€‚</p>

<p><img src="/assets/img/msg2.png" alt=""></p>

<ul>
  <li>å¯ä»¥çœ‹å‡ºä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">Reader</code> å¯¹è±¡å…±ç”¨äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Receiver</code> ã€‚è¿™æ˜¯å› ä¸ºåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œä¸åŒçš„ <code class="language-plaintext highlighter-rouge">Reader</code> å¯¹è±¡è®¢é˜…åŒä¸€ä¸ªä¿¡é“ï¼Œå°±ä¼šä½¿ç”¨åŒä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Receiver</code>
</li>
  <li>é»˜è®¤é€‰æ‹©çš„ <code class="language-plaintext highlighter-rouge">Receiver</code> æ˜¯ hybrid çš„ï¼Œå› æ­¤éœ€è¦ä¸‰ä¸ªåº•å±‚æ¥æ”¶ç±» <code class="language-plaintext highlighter-rouge">IntraReceiver</code> ã€<code class="language-plaintext highlighter-rouge">ShmReceiver</code> å’Œ <code class="language-plaintext highlighter-rouge">RtpsReceiver</code> é…åˆ</li>
  <li>åœ¨åˆ›å»º <code class="language-plaintext highlighter-rouge">Receiver</code> æ—¶ï¼Œç›‘å¬è€…å¤„ç†å‡½æ•° <code class="language-plaintext highlighter-rouge">msg_listener_</code> å°±å·²ç»â€œå‡†å¤‡å°±ç»ªâ€äº†ã€‚</li>
  <li>
<code class="language-plaintext highlighter-rouge">Dispatcher</code> çš„è¡¨ä¸­è®°å½•äº†ç›‘å¬è€…å’Œå®ƒä»¬è´Ÿè´£çš„ä¿¡é“ï¼Œå¹¶æŠŠå®ƒä»¬è¿æ¥ <code class="language-plaintext highlighter-rouge">Connect</code> èµ·æ¥ï¼Œå¦‚åŒ Qt ä¸­çš„ä¿¡å·æ§½æœºåˆ¶</li>
  <li>ä¸€æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ï¼ˆæœ€å·¦è¾¹çš„å‡½æ•°æ˜¯æˆ‘é™Œç”Ÿçš„ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šç«‹åˆ»è§¦å‘ä¿¡å·æ§½æœºåˆ¶ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">msg_listener</code> å‡½æ•°ï¼Œä¹‹åå°±æ˜¯ä¸Šå±‚ <code class="language-plaintext highlighter-rouge">DataDispatcher</code> çš„å·¥ä½œäº†</li>
</ul>

<p>æœ€åçš„æœ€åï¼Œäº‹å®ä¸Šæˆ‘è¿˜æ˜¯è½äº†ä¸€ä¸ªä¸œè¥¿ï¼šæœåŠ¡â€”å®¢æˆ·é€šä¿¡æ–¹å¼ğŸ˜“ğŸ˜“ğŸ˜‚ğŸ˜‚ã€‚çš„ç¡®ï¼Œè¿™ç¯‡åšå®¢çš„å†…å®¹å…¨æ˜¯å…³äºå‘å¸ƒâ€”è®¢é˜…é€šä¿¡æ–¹å¼çš„ï¼Œå¯¹äº <code class="language-plaintext highlighter-rouge">Service</code> å’Œ <code class="language-plaintext highlighter-rouge">Client</code> ï¼Œå‡ ä¹æ²¡æœ‰æåŠï¼Œä¹‹åï¼Œæˆ‘å°±ä¼šè¡¥ä¸Šè¿™ä¸€éƒ¨åˆ†æœåŠ¡å‘ç°çš„å†…å®¹ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p>[1] <a href="https://github.com/daohu527/Dig-into-Apollo/tree/master/cyber">Dig into Apollo - Cyber</a></p>

<p>[2] <a href="https://blog.csdn.net/jinzhuojun/article/details/108066714">è‡ªåŠ¨é©¾é©¶å¹³å°Apollo 5.5é˜…è¯»æ‰‹è®°ï¼šCyber RTä¸­çš„é€šä¿¡ä¼ è¾“</a></p>

<p>[3] <a href="https://blog.csdn.net/qq_25762163/article/details/103803032">ç™¾åº¦Apolloç³»ç»Ÿå­¦ä¹ -Cyber RT é€šä¿¡-ä¸Šå±‚</a></p>

<p>[4] <a href="https://blog.csdn.net/kesalin/article/details/88914029">ç™¾åº¦ Apollo Cyber RTç®€ä»‹ã€åŸºæœ¬æ¦‚å¿µä»¥åŠä¸ ROS å¯¹ç…§</a></p>

<p>[5] <a href="https://blog.csdn.net/qq_25762163/article/details/103895527">ç™¾åº¦Apolloç³»ç»Ÿå­¦ä¹ -Cyber RT é€šä¿¡-åº•å±‚</a></p>

<p>[6] <a href="https://cyber-rt.readthedocs.io/en/latest/api/cppapi.html#cyber-node-reader-h">cyber-rt.readthedocs.io</a></p>

<p>[7] è‡ªåŠ¨é©¾é©¶æ±½è½¦å¹³å°æŠ€æœ¯åŸºç¡€/æ¨ä¸–æ˜¥ç­‰ç¼–è‘—. â€”åŒ—äº¬ï¼šæ¸…åå¤§å­¦å‡ºç‰ˆç¤¾</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> tag: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#apollo" class="page__taxonomy-item" rel="tag">Apollo</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#cyber-rt" class="page__taxonomy-item" rel="tag">Cyber RT</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> category: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#apollo" class="page__taxonomy-item" rel="tag">Apollo</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> update time:</strong> <time datetime="2020-11-07T00:00:00+08:00">November 7, 2020</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">share</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Apollo+Cyber+RT+%E9%80%9A%E4%BF%A1%EF%BC%88%E4%B8%8B%EF%BC%89%20https%3A%2F%2Fdingfen.github.io%2Fapollo%2F2020%2F11%2F07%2FCyberCommu2.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="share Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdingfen.github.io%2Fapollo%2F2020%2F11%2F07%2FCyberCommu2.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="share Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fdingfen.github.io%2Fapollo%2F2020%2F11%2F07%2FCyberCommu2.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="share LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/apollo/2020/11/03/CyberCommu1.html" class="pagination--pager" title="Apollo Cyber RT é€šä¿¡ï¼ˆä¸Šï¼‰
">previous</a>
    
    
      <a href="/apollo/2020/11/11/ApolloPlanning.html" class="pagination--pager" title="Apollo Planning è§„åˆ’æ¨¡å—
">next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">related</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/img/teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/cpp/2022/03/13/gem5-3.html" rel="permalink">æ·±å…¥ç†è§£ Gem5 ä¹‹ä¸‰
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minutes read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">å…³äºgem5ä¸­SimObjectç±»
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/img/teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/cpp/2022/03/08/gem5-2.html" rel="permalink">æ·±å…¥ç†è§£ Gem5 ä¹‹äºŒ
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minutes read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">å…³äºgem5ä¸­åºåˆ—åŒ–ç­‰å®ç°
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/img/teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/cpp/2022/02/24/gem5-1.html" rel="permalink">æ·±å…¥ç†è§£ Gem5 ä¹‹ä¸€
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minutes read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">å…³äºgem5äº‹ä»¶çš„å®ç°
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/img/teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/cpp/2021/11/15/Qt-signal-slot.html" rel="permalink">ä¿¡å·æ§½æœºåˆ¶çš„ç®€é™‹å®ç°
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minutes read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="è¾“å…¥æ‚¨è¦æœç´¢çš„å…³é”®è¯...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>follow:</strong></li>
    

    
      
        
          <li><a href="https://github.com/dingfen" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
        
      
        
          <li><a href="df12138@mail.ustc.edu.cn" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">Â© 2022 Bill Ding. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "https://dingfen.github.io/apollo/2020/11/07/CyberCommu2.html";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/apollo/2020/11/07/CyberCommu2"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://https://dingfen.github.io/.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>


  





  </body>
</html>
