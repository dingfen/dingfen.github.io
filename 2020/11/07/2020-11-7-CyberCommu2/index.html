

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Bill Ding">
  <meta name="keywords" content="">
  
    <meta name="description" content="å¯¹ Cyber RT çš„é€šä¿¡æ¶æ„çš„æ·±å…¥ç ”ç©¶">
<meta property="og:type" content="article">
<meta property="og:title" content="Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰">
<meta property="og:url" content="https://dingfen.github.io/2020/11/07/2020-11-7-CyberCommu2/index.html">
<meta property="og:site_name" content="å³°å­çš„ä¹å›­">
<meta property="og:description" content="å¯¹ Cyber RT çš„é€šä¿¡æ¶æ„çš„æ·±å…¥ç ”ç©¶">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dingfen.github.io/img/CyberLayer.png">
<meta property="og:image" content="https://dingfen.github.io/img/msg.png">
<meta property="og:image" content="https://dingfen.github.io/img/msg2.png">
<meta property="article:published_time" content="2020-11-07T04:00:00.000Z">
<meta property="article:modified_time" content="2025-01-26T11:49:09.199Z">
<meta property="article:author" content="Bill Ding">
<meta property="article:tag" content="Apollo">
<meta property="article:tag" content="Cyber RT">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://dingfen.github.io/img/CyberLayer.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰ - å³°å­çš„ä¹å›­</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"dingfen.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":null,"onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>å³°å­çš„ä¹å›­</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-11-07 12:00" pubdate>
          2020å¹´11æœˆ7æ—¥ ä¸­åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.8k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          48 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    <!-- compatible with older versions-->
                    æ›´æ–°äºï¼š2025-01-26T19:49:09+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h1>Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰</h1>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>æ¬¢è¿å›æ¥ï¼ä»Šå¤©æˆ‘ç»§ç»­å’Œå¤§å®¶èŠ Cyber RT çš„é€šä¿¡ï¼Œ<a href="https://dingfen.github.io/apollo/2020/11/03/CyberCommu1.html">ä¸Šæ–‡</a>æˆ‘æ¢è®¨äº† Cyber RT çš„ä¸¤ç§é€šä¿¡æ–¹å¼å’Œä¸‰ç§é€šä¿¡æ¨¡å‹ï¼Œå¹¶ä»é€šä¿¡æ¶æ„çš„è§’åº¦ï¼Œä¸€å±‚å±‚åœ°ç»™å¤§å®¶è¯¦ç»†ä»‹ç»äº†é€šä¿¡æ—¶ä»£ç çš„å…·ä½“å·¥ä½œæƒ…å†µã€‚ç”±äºé€šä¿¡å†…å®¹è¿‡å¤šï¼Œå…¨æ”¾åœ¨ä¸€ç¯‡åšå®¢ç†è®ºå¤ªé•¿ï¼Œäºæ˜¯æˆ‘å°†è¿™äº›å†…å®¹ç®€å•åœ°ä¸€åˆ†ä¸ºäºŒï¼Œäº‹å®ä¸Šå®ƒä»¬åº”å½“æ˜¯æœ‰æœºçš„æ•´ä½“ã€‚</p>
<p>ä¸Šæ–‡æœ«å°¾ï¼Œæˆ‘ä»‹ç»äº† <code>Blocker</code> ç±»çš„åŠŸèƒ½ï¼Œä»Šå¤©è¿™ç¯‡åšå®¢ï¼Œæˆ‘ä»¬ç»§ç»­å‘æ·±å¤„è¿›å†›â†–(^Ï‰^)â†—ã€‚</p>
<center>
<img src="/img/CyberLayer.png" srcset="/img/loading.gif" lazyload />
</center>
## Receiver & Transmitter
<p>æˆ‘ä»¬åœ¨ä¸Šæ–‡å·²ç»è®¤è¯†äº† <code>Reader</code> å’Œ <code>Writer</code> ï¼Œç°åœ¨ç»§ç»­å¾€ä¸‹èµ°ã€‚å¦‚æœä½ ä»”ç»†çœ‹ä»£ç çš„è¯ï¼Œåœ¨ <code>Reader</code> å’Œ <code>Writer</code> åˆå§‹åŒ–æ—¶ï¼Œéƒ½ä¼šåˆ†åˆ«æ„å»ºå¥½åº•å±‚çš„ <code>Receiver</code> å’Œ <code>Transmitter</code> å¯¹è±¡ã€‚ä¸ºäº†æè¿°ç®€ä¾¿ï¼Œæˆ‘ä¹‹å‰æœ‰æ„åœ°å¿½ç•¥äº†ï¼Œç°åœ¨æŠŠå®ƒæ‹¿å‡ºæ¥ã€‚<code>Reader</code> éƒ¨åˆ†çš„æ¯”è¾ƒå¤æ‚ï¼Œè¿˜ä½¿ç”¨äº† <code>ReceiverManager</code> è¿›è¡Œç®¡ç†ï¼›<code>Writer</code> å°±æ¯”è¾ƒç›´æ¥äº†ï¼Œåœ¨ <code>Init()</code> å‡½æ•°ä¸­å¯ä»¥ç›´æ¥çœ‹åˆ°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">bool</span> Reader&lt;MessageT&gt;::<span class="hljs-built_in">Init</span>() &#123;<br>	receiver_ = ReceiverManager&lt;MessageT&gt;::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">GetReceiver</span>(role_attr_);<br>&#125;<br><br><span class="hljs-type">bool</span> Writer&lt;MessageT&gt;::<span class="hljs-built_in">Init</span>() &#123;<br>   <span class="hljs-comment">/*  ....   */</span><br>    transmitter_ =<br>        transport::Transport::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">CreateTransmitter</span>&lt;MessageT&gt;(role_attr_);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸å¦¨æŠŠè¿™é‡Œä½œä¸ºçªç ´å£ï¼Œæ‰“å¼€æ–°ä¸–ç•Œçš„å¤§é—¨ã€‚</p>
<span id="1">
<h3 id="ReceiverManager">ReceiverManager</h3>
<p>ä¹‹å‰æåˆ°è¿‡ï¼Œ<code>Reader</code> åœ¨åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦ç”¨ <code>ReceiverManager::GetReceiver()</code> è·å¾— <code>Receiver</code> å¯¹è±¡ã€‚å®ƒçš„å†…éƒ¨åˆ†å°è£…äº†ä¸€ä¸ª <code>unordered_map</code> è¡¨ï¼Œå°†ä¿¡é“åå­—å’Œä¸ä¹‹å¯¹åº”çš„ <code>Receiver</code> å¯¹è±¡ä¿å­˜åœ¨è¡¨ä¸­ã€‚å†çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå¯å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œ<em>å¦‚æœåŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œä¸åŒçš„ <code>Reader</code> å¯¹è±¡è®¢é˜…åŒä¸€ä¸ªä¿¡é“ï¼Œäº‹å®ä¸Šä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ª <code>Receiver</code></em> <sup>2</sup>ã€‚å†çœ‹çœ‹é‚£ä¸ªå¾ˆé•¿çš„ <code>CreateReceiver()</code> å‡½æ•°è°ƒç”¨ï¼Œé™¤äº†ä¼ é€’ä¸€ä¸ªé…ç½®ä¿¡æ¯å‚æ•°å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé•¿çš„å›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°ä¼šåšï¼š</p>
<ul>
<li>åŠ å…¥ä¸€ä¸ª Transport äº‹ä»¶ï¼Œç±»å‹ä¸º Dispatch</li>
<li>è°ƒç”¨æ•°æ®åˆ†å‘å™¨ <code>DataDispatcher::Dispatch()</code>  å‡½æ•°</li>
<li>åŠ å…¥ä¸€ä¸ª Transport äº‹ä»¶ï¼Œç±»å‹ä¸º Notify</li>
</ul>
<p>è¿™äº›æ­¥éª¤å…·ä½“åšäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ç›®å‰è¿˜ä¸çŸ¥é“ï¼Œæ±‚çŸ¥çš„æ¬²æœ›é©±ä½¿ç€æˆ‘ä»¬ç»§ç»­å¾€ä¸‹æ¢ç´¢ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> MessageT&gt;<br><span class="hljs-keyword">auto</span> ReceiverManager&lt;MessageT&gt;::<span class="hljs-built_in">GetReceiver</span>(<span class="hljs-type">const</span> proto::RoleAttributes&amp; role_attr) <br>    -&gt; <span class="hljs-keyword">typename</span> std::shared_ptr&lt;transport::Receiver&lt;MessageT&gt;&gt; &#123;<br>  <span class="hljs-comment">// because multi reader for one channel will write datacache multi times,</span><br>  <span class="hljs-comment">// so reader for datacache we use map to keep one instance for per channel</span><br>  <span class="hljs-type">const</span> std::string&amp; channel_name = role_attr.<span class="hljs-built_in">channel_name</span>();<br>    <span class="hljs-comment">// å¦‚æœä¿¡é“åå­—å¯¹åº”çš„ Receiver è¿˜æ²¡æœ‰åˆ›å»º é‚£å°±åˆ›å»º</span><br>  <span class="hljs-keyword">if</span> (receiver_map_.<span class="hljs-built_in">count</span>(channel_name) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// ä¸€ä¸ªå·¨é•¿çš„ CreateReceiver() å‡½æ•°è°ƒç”¨</span><br>    receiver_map_[channel_name] = transport::Transport::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">CreateReceiver</span>&lt;MessageT&gt;(<br>            		role_attr, [](<span class="hljs-type">const</span> std::shared_ptr&lt;MessageT&gt;&amp; msg,<br>                          <span class="hljs-type">const</span> transport::MessageInfo&amp; msg_info,<br>                          <span class="hljs-type">const</span> proto::RoleAttributes&amp; reader_attr) &#123;<br>              (<span class="hljs-type">void</span>)msg_info;<br>              (<span class="hljs-type">void</span>)reader_attr;<br>              PerfEventCache::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">AddTransportEvent</span>(<br>                  TransPerf::DISPATCH, reader_attr.<span class="hljs-built_in">channel_id</span>(),<br>                  msg_info.<span class="hljs-built_in">seq_num</span>());<br>              data::DataDispatcher&lt;MessageT&gt;::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">Dispatch</span>(<br>                  reader_attr.<span class="hljs-built_in">channel_id</span>(), msg);<br>              PerfEventCache::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">AddTransportEvent</span>(<br>                  TransPerf::NOTIFY, reader_attr.<span class="hljs-built_in">channel_id</span>(),<br>                  msg_info.<span class="hljs-built_in">seq_num</span>());<br>            &#125;);<br>  &#125;<br>    <span class="hljs-comment">// å¦‚æœå·²ç»æœ‰äº† ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">return</span> receiver_map_[channel_name];<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Transport">Transport</h3>
<p><code>Transport</code> ç±»ï¼Œå•ä¾‹æ¨¡å¼ï¼Œæœ‰å¦‚ä¸‹æŒ‡é’ˆæˆå‘˜ï¼Œemmâ€¦â€¦åœ¨è¿˜æ²¡å®Œå…¨å¼„æ‡‚åº•å±‚ä»£ç çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¾ˆéš¾å‘Šè¯‰ä½ ä»¬è¿™äº›ç±»çš„å…·ä½“ä½œç”¨ï¼š</p>
<ul>
<li><code>Participant</code> ç±»  FastRtps ç›¸å…³</li>
<li><code>Notifier</code> ç±» ä¸ Shm ç›¸å…³</li>
<li><code>IntraDispatcher</code> ç±» Intra çš„åˆ†å‘å™¨</li>
<li><code>ShmDispatcher</code> ç±» Shm çš„åˆ†å‘å™¨</li>
<li><code>RtpsDispatcher</code> ç±» Rtps çš„åˆ†å‘å™¨</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transport</span> &#123;<br> <span class="hljs-keyword">private</span>:<br>  ParticipantPtr participant_ = <span class="hljs-literal">nullptr</span>;<br>  NotifierPtr notifier_ = <span class="hljs-literal">nullptr</span>;<br>  IntraDispatcherPtr intra_dispatcher_ = <span class="hljs-literal">nullptr</span>;<br>  ShmDispatcherPtr shm_dispatcher_ = <span class="hljs-literal">nullptr</span>;<br>  RtpsDispatcherPtr rtps_dispatcher_ = <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å’Œä¹‹å‰ Cyber RT ç»™äººçš„æ„Ÿè§‰ä¸€æ ·ï¼Œä¸€æ—¦å®ƒè¦åˆ›å»ºä»€ä¹ˆé‡è¦çš„ä¸œè¥¿ï¼Œä¸è°ƒç”¨ä¸ªå‡ å±‚æ˜¯æ ¹æœ¬ä¸å¯èƒ½å®Œæˆçš„ã€‚åœ¨è¿™é‡Œï¼Œ<code>Transport</code> ç±»çš„ä¸¤ä¸ªå‡½æ•° <code>CreateTransmitter</code> å’Œ <code>CreateReceiver</code> éƒ½ä¼šæ ¹æ®ä¼ å…¥çš„ mode ï¼Œå»æ„é€ å‡ºå¯¹åº”çš„å­ç±»å¯¹è±¡ï¼Œåˆ†åˆ«å¯¹åº”æˆ‘åœ¨è¿™ç¯‡åšå®¢å¼€å¤´æåˆ°çš„å››ç§ä¸åŒåœºæ™¯ä¸‹çš„ä¼ è¾“å®ç°ç±»ã€‚å“¦ï¼Œæé†’ä¸€ä¸‹ï¼Œé»˜è®¤çš„ mode æ˜¯ Hybrid ï¼Œä¹Ÿå°±æ˜¯ä¸‰ç§æ¨¡å¼æ··ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Transport::CreateTransmitter</span><span class="hljs-params">(<span class="hljs-type">const</span> RoleAttributes&amp; attr,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> OptionalMode&amp; mode)</span> -&gt; <span class="hljs-keyword">typename</span> std::shared_ptr&lt;Transmitter&lt;M&gt;&gt; </span>&#123;<br>  <span class="hljs-comment">/*  ....  */</span><br> <span class="hljs-comment">// å¾€ modified_attr ä¸­åŠ å…¥ qos profile</span><br> <span class="hljs-comment">// æ ¹æ®å„ç§æ¨¡å¼ åˆ›å»ºç›¸åº”çš„ Transmitter å­ç±»</span><br>  <span class="hljs-keyword">switch</span> (mode) &#123;<br>    <span class="hljs-keyword">case</span> OptionalMode::INTRA:<br>      transmitter = std::make_shared&lt;IntraTransmitter&lt;M&gt;&gt;(modified_attr);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> OptionalMode::SHM:<br>      transmitter = std::make_shared&lt;ShmTransmitter&lt;M&gt;&gt;(modified_attr);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> OptionalMode::RTPS:<br>      transmitter =<br>          std::make_shared&lt;RtpsTransmitter&lt;M&gt;&gt;(modified_attr, <span class="hljs-built_in">participant</span>());<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      transmitter =<br>          std::make_shared&lt;HybridTransmitter&lt;M&gt;&gt;(modified_attr, <span class="hljs-built_in">participant</span>());<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (mode != OptionalMode::HYBRID)<br>    transmitter-&gt;<span class="hljs-built_in">Enable</span>();<br>  <span class="hljs-keyword">return</span> transmitter;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>Transmitter</code> ç±»æ˜¯å†™æ¶ˆæ¯ï¼Œè€Œ <code>Receiver</code> ç±»æ˜¯è¯»æ¶ˆæ¯ï¼Œå› æ­¤ <code>Receiver</code> ç±»æ¯” <code>Transmitter</code> ç±»å¤šäº†ä¸€ä¸ªå‚æ•° <code>MessageListener</code> ï¼Œå…¶æœ¬è´¨å°±æ˜¯ä¸ªå›è°ƒå‡½æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">using</span> MessageListener = std::function&lt;<span class="hljs-built_in">void</span>(<span class="hljs-type">const</span> MessagePtr&amp;, <span class="hljs-type">const</span> MessageInfo&amp;, <span class="hljs-type">const</span> RoleAttributes&amp;)&gt;;<br></code></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Transport::CreateReceiver</span><span class="hljs-params">(<span class="hljs-type">const</span> RoleAttributes&amp; attr,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-keyword">typename</span> Receiver&lt;M&gt;::MessageListener&amp; msg_listener,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> OptionalMode&amp; mode)</span> -&gt; <span class="hljs-keyword">typename</span> std::shared_ptr&lt;Receiver&lt;M&gt;&gt; </span>&#123;<br> <span class="hljs-comment">/*  ....   */</span><br> <span class="hljs-comment">// å¾€ modified_attr ä¸­åŠ å…¥ qos profile</span><br> <span class="hljs-comment">// æ ¹æ®å„ç§æ¨¡å¼ åˆ›å»ºç›¸åº”çš„ Receiver å­ç±»</span><br>  <span class="hljs-keyword">switch</span> (mode) &#123;<br>    <span class="hljs-keyword">case</span> OptionalMode::INTRA:<br>      receiver =<br>          std::make_shared&lt;IntraReceiver&lt;M&gt;&gt;(modified_attr, msg_listener);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> OptionalMode::SHM:<br>      receiver = std::make_shared&lt;ShmReceiver&lt;M&gt;&gt;(modified_attr, msg_listener);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> OptionalMode::RTPS:<br>      receiver = std::make_shared&lt;RtpsReceiver&lt;M&gt;&gt;(modified_attr, msg_listener);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      receiver = std::make_shared&lt;HybridReceiver&lt;M&gt;&gt;(<br>          modified_attr, msg_listener, <span class="hljs-built_in">participant</span>());<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (mode != OptionalMode::HYBRID)<br>    receiver-&gt;<span class="hljs-built_in">Enable</span>();<br>  <span class="hljs-keyword">return</span> receiver;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æœ€åä¸€éƒ¨åˆ†ä»£ç ï¼šåœ¨ <code>Receiver</code> å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œåªè¦æ¨¡å¼ä¸æ˜¯ Hybridï¼Œéƒ½ä¼šç«‹åˆ»è°ƒç”¨ <code>Receiver::Enable()</code> å‡½æ•°å¼€å¯æ¥æ”¶ã€‚</p>
<span id="2">
<h3 id="Receiver-Transmitter">Receiver &amp; Transmitter</h3>
<p>è¿™ä¸¤ä¸ªç±»æ˜¯ <code>EndPoint</code> çš„å­ç±»ã€‚å…³äº <code>Endpoint</code> ç±»<sup>5</sup>ï¼Œé‚£å¯å°±æ˜¯æ•´ä¸ªæ¶æ„çš„ç±»ç»§æ‰¿çš„ç»ˆç‚¹äº†ï¼Œå…¶å†…éƒ¨æœ‰ä¸‰ä¸ªæˆå‘˜</p>
<ul>
<li><code>bool enabled_</code> ç”¨æ¥æ ‡è®°æ˜¯å¦è¢«å¯ç”¨</li>
<li><code>Identity id_</code> ç”¨äºæ ‡è¯†ï¼Œå¯¹äºæ¯ä¸ª <code>Endpoint</code> å¯¹è±¡æ‹¥æœ‰å”¯ä¸€çš„ id å·ï¼Œå…¶å­ç±»ä¹Ÿæ˜¯ç”¨è¿™ä¸ªæ¥è¿›è¡Œæ ‡è¯†</li>
<li><code>RoleAttributes attr_</code> ç”¨æ¥è®°å½•é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚</li>
</ul>
<p>å…¶ä¸­ <code>Receiver</code> ç±»åªæœ‰ä¸€ä¸ªå›è°ƒå‡½æ•° <code>msg_listener_</code>ï¼Œè¯¥å›è°ƒå‡½æ•°å°±æ˜¯ <code>Receiver</code> æ„é€ æ—¶ä¼ å…¥çš„å‡½æ•°ã€‚åœ¨æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œä¼šè¢«è°ƒç”¨ğŸ‘‡ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-type">void</span> Receiver&lt;M&gt;::<span class="hljs-built_in">OnNewMessage</span>(<span class="hljs-type">const</span> MessagePtr&amp; msg,<br>                               <span class="hljs-type">const</span> MessageInfo&amp; msg_info) &#123;<br>  <span class="hljs-keyword">if</span> (msg_listener_ != <span class="hljs-literal">nullptr</span>)<br>    <span class="hljs-built_in">msg_listener_</span>(msg, msg_info, attr_);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨ <a href="#1">ReceiverManager</a> é‚£ä¸€å°èŠ‚ä¸­ï¼Œå·²ç»è¯´åˆ°è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼Œå…¶ä¸­<sup>5</sup>ï¼Œè°ƒç”¨ <code>DataDispatcher::Dispatch</code> éå¸¸å…³é”®ã€‚å› ä¸ºä»è¿™æ­¥å¯ä»¥çœ‹å‡ºä¸Šå±‚å’Œåº•å±‚æœ€ç»ˆå®Œæˆäº†é—­ç¯ã€‚å½“åº•å±‚ <code>Receiver</code> çš„å›è°ƒå‡½æ•° <code>msg_listener</code> æ”¶åˆ°æ¶ˆæ¯è¢«è°ƒç”¨æ—¶ï¼Œä¸Šå±‚çš„åˆ†å‘å™¨ <code>DataDispatcher</code> ä¼šæŠŠæ¥è‡ªåº•å±‚çš„æ¶ˆæ¯å‘åˆ°ç­‰å¾…çš„æ¶ˆæ¯ç¼“å­˜é‡Œï¼Œç„¶åè°ƒç”¨ä¸Šå±‚çš„é€šçŸ¥å™¨ <code>DataNotifier::Notify()</code> ï¼Œå”¤é†’å¯¹åº”çš„ <code>Component</code> çš„å°è£…äº† <code>Process()</code> çš„åç¨‹ï¼Œè®©åç¨‹å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</p>
<p>å†çœ‹çœ‹ <code>Receiver</code> çš„å››ä¸ªå­ç±»ï¼Œæ¯ä¸ªå­ç±»éƒ½åŒ…å«äº†ç›¸åº”çš„ Dispatcher çš„æŒ‡é’ˆï¼Œä¾‹å¦‚ï¼Œ<code>RtpsReceiver</code> ç±»å«æœ‰ <code>RtpsDispatcherPtr</code> æˆå‘˜ã€‚è¿™äº› Dispatcher çš„åŠŸèƒ½å°±æ˜¯å¢åˆ ç›‘å¬è€…ï¼Œä»è€Œè®© <code>Receiver</code> å…³é—­æˆ–å¼€å¯ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-type">void</span> RtpsReceiver&lt;M&gt;::<span class="hljs-built_in">Enable</span>() &#123;<br> <span class="hljs-comment">/*  ....  */</span><br>  dispatcher_-&gt;<span class="hljs-built_in">AddListener</span>&lt;M&gt;(<br>      <span class="hljs-keyword">this</span>-&gt;attr_, std::<span class="hljs-built_in">bind</span>(&amp;RtpsReceiver&lt;M&gt;::OnNewMessage, <span class="hljs-keyword">this</span>,<br>                             std::placeholders::_1, std::placeholders::_2));<br>  <span class="hljs-keyword">this</span>-&gt;enabled_ = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-type">void</span> RtpsReceiver&lt;M&gt;::<span class="hljs-built_in">Disable</span>() &#123;<br>  dispatcher_-&gt;<span class="hljs-built_in">RemoveListener</span>&lt;M&gt;(<span class="hljs-keyword">this</span>-&gt;attr_);<br>  <span class="hljs-keyword">this</span>-&gt;enabled_ = <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç®€å•åœ°ä»‹ç»ä¸€ä¸‹ <code>Dispatcher</code> ç±»ï¼ˆåˆ«å’Œä¸‹é¢çš„ <code>DataDispatcher</code> ææ··äº†ï¼‰ã€‚å®ƒä¸»è¦è´Ÿè´£è®°å½•ä¸€ä¸ª <code>channel_id</code> å’Œå¯¹åº” <code>ListenerHandlerBasePtr</code> çš„å…³ç³»è¡¨ã€‚è€Œ<code>AddListener()</code> å’Œ <code>RemoveListener()</code> å‡½æ•°æ˜¯ä»å…³ç³»è¡¨ä¸­ï¼Œæ‹¿åˆ°ç»™å®šä¿¡é“çš„å¯¹åº” <code>ListenerHandlerBase</code> ï¼Œå¹¶åœ¨è¿™ä¸Šé¢è¿æ¥ï¼ˆConnectï¼‰æˆ–ä¸è¿æ¥ï¼ˆDisconnectï¼‰ç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚ç”±äºæ—¶é—´ç²¾åŠ›æœ‰é™ï¼Œè¿™è¾¹è§£é‡Šå¾—æ¯”è¾ƒæ··ä¹±ï¼Œè‹¥æƒ³å…·ä½“äº†è§£å…¶å·¥ä½œæœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æœ€åçš„æ–‡çŒ®ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æœ‰ç‚¹åƒåœ¨ <a target="_blank" rel="noopener" href="https://www.qt.io/cn">Qt</a> ä¸­å®ç°çš„ä¿¡å·æ§½æœºåˆ¶ï¼šä¿¡å·åœ¨ç‰¹å®šæƒ…å†µä¸‹è¢«å‘å°„å‡ºå»ï¼Œå¯¹åº”çš„ä¿¡å·å“åº”å‡½æ•°åœ¨æ§½ä¸­ç›‘å¬ã€‚ä¿¡å·ä¸æ§½é€šè¿‡ Connect å‡½æ•°å…³è”ï¼Œä¸€ä¸ªä¿¡å·å¯ä»¥å‘å°„åˆ°å¤šä¸ªæ§½ï¼Œå¤šä¸ªä¿¡å·å¯ä»¥è¢«ä¸€ä¸ªæ§½ç›‘å¬ã€‚</p>
<hr>
<p>å†æ¥çœ‹çœ‹ <code>Transmitter</code> ç±»ï¼Œå®ƒæ˜¯çœŸæ­£çš„æ•°æ®å†™è€…çš„åŸºç±»ã€‚å®ƒæœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œåˆ†åˆ«ä¸ºåºåˆ—å· <code>seq_num_</code> å’Œæ¶ˆæ¯ä¿¡æ¯ <code>msg_info_</code> ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transmitter</span> : <span class="hljs-keyword">public</span> Endpoint &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Transmitter</span><span class="hljs-params">(<span class="hljs-type">const</span> RoleAttributes&amp; attr)</span></span>;<br>  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">Transmit</span><span class="hljs-params">(<span class="hljs-type">const</span> MessagePtr&amp; msg)</span></span>;<br>  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">Transmit</span><span class="hljs-params">(<span class="hljs-type">const</span> MessagePtr&amp; msg, <span class="hljs-type">const</span> MessageInfo&amp; msg_info)</span> </span>= <span class="hljs-number">0</span>;<br><br>  <span class="hljs-function"><span class="hljs-type">uint64_t</span> <span class="hljs-title">NextSeqNum</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> ++seq_num_; &#125;<br>  <span class="hljs-function"><span class="hljs-type">uint64_t</span> <span class="hljs-title">seq_num</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> seq_num_; &#125;<br> <span class="hljs-keyword">protected</span>:<br>  <span class="hljs-type">uint64_t</span> seq_num_;<br>  MessageInfo msg_info_;<br>&#125;;<br><br></code></pre></td></tr></table></figure>
<p>æˆ‘ä¸»è¦ç ”ç©¶å…¶ä¸­çš„ <code>Transmit()</code> å‡½æ•°ï¼Œå…¶å››ä¸ªå­ç±»éƒ½å…·ä½“å®ç°äº† <code>Transmit()</code> å‡½æ•°ï¼Œå¦‚æœä½ ä»”ç»†çœ‹è¿‡å‰ä¸€ç¯‡åšå®¢ï¼Œå°±çŸ¥é“è¿™ä¹Ÿæ˜¯ <code>Writer</code> ç±»ä¸€ç›´åœ¨è°ƒç”¨çš„å‡½æ•°ã€‚é‚£ä¹ˆè¿™ä¸ª <code>Transmit()</code> å‡½æ•°æœ‰ä»€ä¹ˆå…·ä½“æ­¥éª¤å‘¢ï¼Ÿ</p>
<ul>
<li><code>Writer</code> è°ƒç”¨ <code>Transmitter::Transmit()</code> å‡½æ•°</li>
<li>è®¾ç½® <code>msg_info::seq_num = NextSeqNum</code> æ¶ˆæ¯çš„åºåˆ—å·</li>
<li>åŠ å…¥ä¸€ä¸ª Transportäº‹ä»¶ï¼Œç±»å‹ä¸º Transmit Begin</li>
<li>è°ƒç”¨å­ç±»å®ç°çš„ <code>Transmit()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°é€šè¿‡ä¼ å…¥ä¸€æ¡æ¶ˆæ¯å³å¯ä»¥å®Œæˆæ•°æ®å†™å…¥ä»»åŠ¡ã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M&gt;<br><span class="hljs-type">bool</span> Transmitter&lt;M&gt;::<span class="hljs-built_in">Transmit</span>(<span class="hljs-type">const</span> MessagePtr&amp; msg) &#123;<br>  msg_info_.<span class="hljs-built_in">set_seq_num</span>(<span class="hljs-built_in">NextSeqNum</span>());<br>  PerfEventCache::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">AddTransportEvent</span>(<br>      TransPerf::TRANSMIT_BEGIN, attr_.<span class="hljs-built_in">channel_id</span>(), msg_info_.<span class="hljs-built_in">seq_num</span>());<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Transmit</span>(msg, msg_info_);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>å¥½ï¼Œæˆ‘å¯¹ <code>Receiver</code> å’Œ <code>Transmitter</code> ç±»çš„ä»‹ç»å°±åˆ°è¿™é‡Œäº†ã€‚æˆ‘ä¸æ‰“ç®—å†ç»§ç»­ä»‹ç»å®ƒä»¬çš„å­ç±»ä»¥åŠæ›´åŠ åº•å±‚çš„è®¾è®¡æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå› ä¸ºè¿™è¾¹ç‰µæ‰¯åˆ°éå¸¸å¤šçš„æŠ€æœ¯ç»†èŠ‚ï¼Œå¼„æ‡‚è¿™äº›ä¼šæ¶ˆè€—éå¸¸å¤šçš„ç²¾åŠ›ï¼Œè€Œä¸”è¿™äº›ä¸œè¥¿ä¹Ÿè¿œè¿œè¶…å‡ºäº†è¯¾é¢˜ç»„ç›®å‰çš„è¦æ±‚ã€‚</p>
<h2 id="Data-éƒ¨åˆ†">Data éƒ¨åˆ†</h2>
<p>é€šä¿¡æ¶æ„çš„å†…å®¹å·²ç»å…¨éƒ¨ä»‹ç»å®Œäº†ï¼ˆè‡³å°‘å¯¹äºå‘å¸ƒâ€”è®¢é˜…é€šä¿¡æ–¹å¼æ¥è¯´ï¼‰ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰ç¼ºäº†ä»€ä¹ˆä¸œè¥¿ï¼ŒæŠŠè¿™ä¸¤è€…æœ‰æ•ˆåœ°è¿æ¥èµ·æ¥ğŸ˜…ã€‚æ²¡é”™ï¼Œæˆ‘è‡³ä»Šè¿˜æ²¡æœ‰è¯´æ¸…æ¥šï¼Œ<code>Writer</code> å‘å¸ƒçš„æ¶ˆæ¯æ˜¯å¦‚ä½•è®© <code>Reader</code> çœ‹åˆ°çš„ã€‚è€Œè¿™å°±ç‰µæ‰¯åˆ° <code>cyber/data</code> ä¸­å®ç°çš„ç±»äº†ã€‚</p>
<h3 id="DataVisitor">DataVisitor</h3>
<p>å…ˆæ¥è¯´è¯´æ•°æ®è®¿é—®ç±» <code>DataVisitor</code> ï¼Œå®ƒæ˜¯ <code>DataVisitorBase</code> çš„å­ç±»ã€‚å®ƒçš„ä¸»è¦æˆå‘˜å’Œæ„é€ å‡½æ•°å¦‚ä¸‹ã€‚å…ˆæ¥è¯´å‡ ä¸ªæ˜æ˜¾å¯ä»¥å¾—åˆ°çš„ç»“è®ºï¼š</p>
<ul>
<li><code>DataVisitor</code> å¯¹è±¡éƒ½ä¼šæœ‰è‹¥å¹²ä¸ªç¼“å­˜ç±» <code>ChannelBuffer</code> ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>DataFusion</code> å¯¹è±¡ï¼Œèåˆäº†æ‰€æœ‰çš„æ¶ˆæ¯ç±»å‹</li>
<li>åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé¦–å…ˆæ„å»ºè¿™äº› <code>ChannelBuffer</code> ï¼Œç„¶åå®ƒä»¬éƒ½ä¼šè¢«åŠ å…¥åˆ°<strong>ç›¸åº”ç±»å‹</strong>çš„ <code>DataDispatcher</code> çš„ç®¡ç†ä¸­</li>
<li><code>data_notifier_</code> ï¼ˆå­˜åœ¨äº <code>DataVisitorBase</code> ä¸­ï¼‰ï¼Œä¼šå‘ä¿¡é“ 0 åŠ å…¥ä¸€ä¸ª <code>notifier_</code> ï¼Œç±»å‹ä¸º <code>struct Notifier &#123; std::function&lt;void()&gt; callback; &#125;;</code>ï¼Œè¿™è¡¨æ˜ä¿¡é“ 0 æ³¨å®šä¸å…¶ä»–ä¿¡é“ä¸ä¸€èˆ¬ :thinking:</li>
<li><code>data_fusion_</code> ä¼šæ„å»ºå¹¶æŒ‡å‘ <code>AllLatest</code> å¯¹è±¡ï¼Œä»ç±»å‹æ¥çœ‹ï¼Œå®ƒä»¬æ•´åˆäº†æ‰€æœ‰çš„æ¶ˆæ¯ç±»å‹ï¼Œåº”å½“ç”¨äºä¿¡æ¯çš„æœ€åæ”¶é›†å‘é€</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M0, <span class="hljs-keyword">typename</span> M1&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataVisitor</span>&lt;M0, M1, NullType, NullType&gt; : <span class="hljs-keyword">public</span> DataVisitorBase &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">DataVisitor</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;VisitorConfig&gt;&amp; configs)</span></span><br><span class="hljs-function">      : buffer_m0_(configs[<span class="hljs-number">0</span>].channel_id, new BufferType&lt;M0&gt;(configs[<span class="hljs-number">0</span>].queue_size)),</span><br><span class="hljs-function">     buffer_m1_(configs[<span class="hljs-number">1</span>].channel_id, new BufferType&lt;M1&gt;(configs[<span class="hljs-number">1</span>].queue_size)) &#123;</span><br>    DataDispatcher&lt;M0&gt;::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">AddBuffer</span>(buffer_m0_);<br>    DataDispatcher&lt;M1&gt;::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">AddBuffer</span>(buffer_m1_);<br>    data_notifier_-&gt;<span class="hljs-built_in">AddNotifier</span>(buffer_m0_.<span class="hljs-built_in">channel_id</span>(), notifier_);<br>    data_fusion_ = <span class="hljs-keyword">new</span> fusion::<span class="hljs-built_in">AllLatest</span>&lt;M0, M1&gt;(buffer_m0_, buffer_m1_);<br>  &#125;<br> <span class="hljs-keyword">private</span>:<br>  fusion::DataFusion&lt;M0, M1&gt;* data_fusion_ = <span class="hljs-literal">nullptr</span>;<br>  ChannelBuffer&lt;M0&gt; buffer_m0_;<br>  ChannelBuffer&lt;M1&gt; buffer_m1_;<br>&#125;;<br><br><span class="hljs-comment">/** DataVisitorBase å†…æœ‰</span><br><span class="hljs-comment"> * æŒ‡å‘ DataNotifier çš„æŒ‡é’ˆ</span><br><span class="hljs-comment"> * å°è£…ä¸º Notifier çš„å›è°ƒå‡½æ•°  */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataVisitorBase</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterNotifyCallback</span><span class="hljs-params">(std::function&lt;<span class="hljs-type">void</span>()&gt;&amp;&amp; callback)</span> </span>&#123;<br>    notifier_-&gt;callback = callback;<br>  &#125;<br> <span class="hljs-keyword">protected</span>:<br>  <span class="hljs-type">uint64_t</span> next_msg_index_ = <span class="hljs-number">0</span>;<br>  DataNotifier* data_notifier_ = DataNotifier::<span class="hljs-built_in">Instance</span>();<br>  std::shared_ptr&lt;Notifier&gt; notifier_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><em>è¯¥ç±»ä¸»è¦ç”¨äºæ¶ˆæ¯æ•°æ®çš„è®¿é—®ï¼Œå­˜æ”¾åˆ°æ¥çš„æ¶ˆæ¯æ•°æ®ï¼Œå¹¶æä¾›æ¥å£ä¾›æ¶ˆæ¯è¯»å–</em>ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨è®¨è®º<a href="https://dingfen.github.io/apollo/2020/10/25/CyberComponent.html#%E7%9C%9F%E5%AE%9E%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%A8%A1%E6%8B%9F%E6%A8%A1%E5%BC%8F">ç»„ä»¶çš„åˆå§‹åŒ–çš„æœ€åéƒ¨åˆ†æ—¶</a>è§è¿‡å®ƒï¼Œä¹Ÿåœ¨<a href="https://dingfen.github.io/apollo/2020/11/03/CyberCommu1.html#reader-%E7%B1%BB">è®¢é˜…è€…åˆå§‹åŒ–æ—¶é‡è§è¿‡å®ƒ</a>ï¼Œä½†å½“æ—¶æˆ‘éƒ½æœ‰æ„åœ°ç•¥è¿‡äº†ã€‚ç°åœ¨æˆ‘ä»¬é‡æ‹¾è¿™éƒ¨åˆ†å†…å®¹ï¼ˆä¸ºäº†ç®€å•ä¸”ä¸å¤±ä¸€èˆ¬æ€§ï¼Œæˆ‘ä»¥ä¸¤ä¸ªä¿¡é“çš„æƒ…å†µä¸ºä¾‹ï¼‰ï¼ŒæŠŠè¿™éƒ¨åˆ†å½»åº•ææ˜ç™½ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> M0, <span class="hljs-keyword">typename</span> M1&gt;<br><span class="hljs-type">bool</span> Component&lt;M0, M1, NullType, NullType&gt;::<span class="hljs-built_in">Initialize</span>() &#123;<br>   <span class="hljs-comment">/*   ....   */</span><br>  <span class="hljs-comment">// åˆ›å»º DataVisitor å’Œ RoutineFactory   æœ€ååˆ›å»ºä»»åŠ¡</span><br>  std::vector&lt;data::VisitorConfig&gt; config_list;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; reader : readers_)<br>    config_list.<span class="hljs-built_in">emplace_back</span>(reader-&gt;<span class="hljs-built_in">ChannelId</span>(), reader-&gt;<span class="hljs-built_in">PendingQueueSize</span>());<br>   <span class="hljs-comment">// åˆ›å»ºäº†ä¸¤ä¸ªä¿¡é“çš„ DataVisitor å¹¶ç”¨åœ¨äº†åç¨‹å·¥å‚ç±»</span><br>  <span class="hljs-keyword">auto</span> dv = std::make_shared&lt;data::DataVisitor&lt;M0, M1&gt;&gt;(config_list);<br>  croutine::RoutineFactory factory = croutine::<span class="hljs-built_in">CreateRoutineFactory</span>&lt;M0, M1&gt;(func, dv);<br>  <span class="hljs-keyword">return</span> sched-&gt;<span class="hljs-built_in">CreateTask</span>(factory, node_-&gt;<span class="hljs-built_in">Name</span>());<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç åšäº†ï¼š</p>
<ul>
<li>
<p>æ”¶é›†äº†æ‰€æœ‰çš„ <code>Reader</code> å¯¹è±¡çš„æ‰€è¯»ä¿¡é“ id å’Œæ¶ˆæ¯é˜Ÿåˆ—å¤§å°ï¼Œæ”¾å…¥åˆ° <code>config_list</code> åå°±åˆ›å»º <code>DataVisitor</code> å¯¹è±¡</p>
</li>
<li>
<p>åœ¨ä¸Šé¢ <code>DataVisitor</code> ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæ ¹æ®ä¼ å…¥çš„ä¿¡é“ id å’Œæ¶ˆæ¯é˜Ÿåˆ—å°ºå¯¸ï¼Œ<code>DataVisitor</code> å†…ä¸ºå…¶åˆ›å»ºäº†ä¸¤ä¸ª <code>ChannelBuffer</code> ä½œä¸ºç¼“å†²åŒº</p>
<ul>
<li>è°ƒç”¨æ•°æ®åˆ†å‘å™¨å°†å®ƒä»¬åŠ å…¥åˆ° <code>DataDispatcher</code> çš„ç®¡ç†ä¸­</li>
<li>è°ƒç”¨ <code>DataNotifier::AddNotifier()</code> å‡½æ•°ï¼Œä¼ å…¥ç¬¬ 0 ä¸ªè¯»è€…çš„ä¿¡é“ id ï¼ŒåŠ å…¥åˆ° <code>DataNotifier</code> çš„ç®¡ç†ä¸­ã€‚<code>DataDispatcher</code> ä¸ <code>DataNotifier</code> ç±»å‡ä¸ºå•ä¾‹ï¼Œä¹‹åæˆ‘ä»¬ä¼šå¯¹å®ƒä»¬åšè¯¦ç»†ä»‹ç»</li>
<li>åˆ›å»º <code>DataFusion</code> å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯ä¹‹åè¦äº†è§£çš„â•®(â•¯â–½â•°)â•­</li>
</ul>
</li>
<li>
<p>åˆ›å»ºåç¨‹å·¥å‚ï¼Œå¹¶æ„å»ºå‡ºè¦å°è£…ä¸ºåç¨‹çš„å‡½æ•°ï¼š</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++">factory.create_routine = [=]() &#123;<br><span class="hljs-keyword">return</span> [=]() &#123;<br>  std::shared_ptr&lt;M0&gt; msg0;     std::shared_ptr&lt;M1&gt; msg1;<br>  <span class="hljs-keyword">for</span> (;;) &#123;<br>    CRoutine::<span class="hljs-built_in">GetCurrentRoutine</span>()-&gt;<span class="hljs-built_in">set_state</span>(RoutineState::DATA_WAIT);<br>    <span class="hljs-keyword">if</span> (dv-&gt;<span class="hljs-built_in">TryFetch</span>(msg0, msg1)) &#123;  <span class="hljs-comment">// å–æ•°æ®</span><br>      <span class="hljs-built_in">f</span>(msg0, msg1);	<span class="hljs-comment">// f å‡½æ•°å°±æ˜¯ç»„ä»¶åˆå§‹åŒ–æ—¶åˆ›å»ºçš„ func å‡½æ•°</span><br>      CRoutine::<span class="hljs-built_in">Yield</span>(RoutineState::READY);<br>    &#125; <span class="hljs-keyword">else</span><br>      CRoutine::<span class="hljs-built_in">Yield</span>();<br>  &#125;<br>&#125;; &#125;;<br></code></pre></td></tr></table></figure>
<p>åç¨‹åšçš„å°±æ˜¯è°ƒç”¨ <code>dv-&gt;TryFetch()</code> å–æ•°æ®ï¼ˆä¸‹æ–‡ä¼šè¯¦ç»†è¯´æ˜ï¼‰ï¼Œå¦‚æœæˆåŠŸå°±è°ƒç”¨ç»„ä»¶çš„ <code>Process()</code> å‡½æ•°ï¼Œä¸”åç¨‹çš„çŠ¶æ€ä»ç­‰å¾…æ•°æ®è½¬å˜ä¸ºäº†å°±ç»ªï¼Œè€Œä¸€æ—¦åç¨‹å°±ç»ªï¼Œå°±å¯ä»¥è¢« <code>Processor</code> ç±»è¿è¡Œ</p>
</li>
<li>
<p><code>Scheduler</code> åˆ›å»ºä»»åŠ¡ï¼Œåœ¨<code>CreateTask()</code> å‡½æ•°ä¸­ï¼Œè°ƒç”¨ <code>visitor-&gt;RegisterNotifyCallback()</code> å‡½æ•°</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">visitor-&gt;<span class="hljs-built_in">RegisterNotifyCallback</span>([<span class="hljs-keyword">this</span>, task_id]() &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">cyber_unlikely</span>(stop_.<span class="hljs-built_in">load</span>()))<br>    <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">NotifyProcessor</span>(task_id);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å‡½æ•°è¢«èµ‹å€¼ç»™äº† <code>DataVisitorBase::notifier_</code> ï¼Œç”¨äºå”¤é†’ç›¸åº”çš„åç¨‹æ¥å¤„ç†è¯¥æ–°æ¶ˆæ¯</p>
</li>
</ul>
<p>è¯´å®Œè¿™éƒ¨åˆ†è¿‡ç¨‹åï¼Œæˆ‘å‘ç°æˆ‘ä»¬è‡³å°‘è¿˜è¦ç†è§£ä¸€ä¸‹ <code>DataDispatcher</code> ã€ <code>DataNotifier</code> ã€ <code>DataFusion</code> å’Œ <code>AllLatest</code> ç±»ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚</p>
<h3 id="DataDispatcher">DataDispatcher</h3>
<p>åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚å…ˆæ¥çœ‹çœ‹æ•°æ®åˆ†å‘ç±» <code>DataDispatcher</code> ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒå°†åº•å±‚ä¼ æ¥çš„æ•°æ®è¿›è¡Œåˆ†å‘ï¼Œå…·ä½“æ¥è¯´ï¼Œå½“æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œé€šè¿‡ <code>Dispatch()</code> å‡½æ•°æŠŠå®ƒä»¬æ”¾åˆ°è¯¥ä¿¡é“ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯ç¼“å†²åŒºä¸­ã€‚å®ƒæ˜¯ä¸ªå•ä¾‹æ¨¡å¼ï¼Œä½†æ˜¯ä¸ªæ¨¡æ¿ç±»ï¼Œæ„å‘³ç€æ¯ä¸€ä¸ªæ¶ˆæ¯ç±»å‹ä¼šæœ‰å¯¹åº”çš„ä¸€ä¸ªå”¯ä¸€çš„ <code>DataDispatcher</code> å¯¹è±¡ã€‚ç±»å†…è®°å½•äº†ä¸€ä¸ªä¿¡é“ id ä¸å¤šä¸ª <code>CacheBuffer</code> å¯¹è±¡å¯¹åº”çš„è¡¨ã€‚æ³¨æ„åˆ°ï¼šä¸€ä¸ªä¿¡é“å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€… <code>Reader</code> ï¼Œæ¯ä¸ªè®¢é˜…è€…æ‹¥æœ‰ä¸€ä¸ª <code>CacheBuffer</code> ç¼“å†²åŒºï¼Œè€Œè¿™ä¸ªç¼“å†²åŒºå°±æ˜¯ä¹‹å‰ <code>DataVisitor</code> ç±»åœ¨æ„é€ æ—¶ç»™æ¯ä¸ªæ¶ˆæ¯ç±»å‹åˆ›å»ºçš„ <code>ChannelBuffer</code> ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataDispatcher</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AddBuffer</span><span class="hljs-params">(<span class="hljs-type">const</span> ChannelBuffer&lt;T&gt;&amp; channel_buffer)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Dispatch</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> channel_id, <span class="hljs-type">const</span> std::shared_ptr&lt;T&gt;&amp; msg)</span></span>;<br> <span class="hljs-keyword">private</span>:<br>  DataNotifier* notifier_ = DataNotifier::<span class="hljs-built_in">Instance</span>();<br>  AtomicHashMap&lt;<span class="hljs-type">uint64_t</span>, BufferVector&gt; buffers_map_;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-type">bool</span> DataDispatcher&lt;T&gt;::<span class="hljs-built_in">Dispatch</span>(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> channel_id,<br>                                 <span class="hljs-type">const</span> std::shared_ptr&lt;T&gt;&amp; msg) &#123;<br>  BufferVector* buffers = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (apollo::cyber::<span class="hljs-built_in">IsShutdown</span>())<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// æ¯æ¬¡æ”¶åˆ°è¯¥ä¿¡é“çš„æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šç»™æ‰€æœ‰ç¼“å†²åŒºéƒ½æ”¾ä¸€ä»½æ¶ˆæ¯</span><br>  <span class="hljs-keyword">if</span> (buffers_map_.<span class="hljs-built_in">Get</span>(channel_id, &amp;buffers)) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; buffer_wptr : *buffers)<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> buffer = buffer_wptr.<span class="hljs-built_in">lock</span>()) &#123;<br>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(buffer-&gt;Mutex())</span></span>;<br>       <span class="hljs-comment">// å‘ CacheBuffer å¡«å…¥æ•°æ®</span><br>        buffer-&gt;<span class="hljs-built_in">Fill</span>(msg);<br>      &#125;<br>  &#125; <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">return</span> notifier_-&gt;<span class="hljs-built_in">Notify</span>(channel_id);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>DataDispatcher::Dispatch()</code> å‡½æ•°éå¸¸é‡è¦ï¼Œåœ¨ <a href="#1">ReceiverManager</a> å’Œ <a href="#2">Receiver &amp;&amp; Transmitter</a> ä¸­æˆ‘ä»¬å·²ç»æåˆ°ï¼Œä»–æ˜¯è¿æ¥ä¸Šå±‚å’Œåº•å±‚çš„æœ€å…³é”®ä¸€ç¯ã€‚åœ¨ <code>Receiver</code> å¯¹è±¡æ¯æ¬¡æ”¶åˆ°è¯¥ä¿¡é“çš„æ¶ˆæ¯æ—¶ï¼Œå°±ä¼šè°ƒç”¨<code>DataDispatcher::Dispatch()</code> å‡½æ•°åˆ†å‘åˆšæ”¶åˆ°çš„æ•°æ®ï¼Œå‡½æ•°ä¼šå…ˆä»è¡¨ä¸­å–å‡ºæ‰€æœ‰å¯¹åº”ä¿¡é“çš„ç¼“å†²åŒºï¼Œç„¶åè°ƒç”¨ <code>CacheBuffer::Fill()</code> å‡½æ•°æ¥ç»™ç¼“å†²åŒºå¡«æ•°æ®ï¼ˆç¨åä»‹ç»è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œæœ€åè°ƒç”¨ <code>DataNotifier::Notify()</code> å‡½æ•°ï¼Œå”¤é†’å®ƒä»¬å¯¹åº”çš„åç¨‹æ¥å–æ•°æ®å¹¶è¿è¡Œã€‚ç°åœ¨ä½ åº”è¯¥æ˜ç™½ï¼Œä¸ºä½• <code>DataVisitor</code> åœ¨æ„é€ æ—¶ï¼Œéœ€è¦æŠŠåˆšåˆšå»ºç«‹çš„ç¼“å†²åŒºç»™ <code>DataDispatcher</code> ç®¡ç†ï¼Œä¸ç„¶çš„è¯ï¼Œç¼“å†²åŒºæ‹¿ä¸åˆ°æ¶ˆæ¯å•Šã€‚</p>
<h3 id="DataNotifier">DataNotifier</h3>
<p>å†æ¥çœ‹çœ‹ <code>DataNotifier</code> ç±»ã€‚å®ƒæ˜¯ä¸ªå•ä¾‹æ¨¡å¼ï¼Œç±»å†…æœ‰ä¸€ä¸ªä¿¡é“ id ä¸å¤šä¸ª <code>Notifer</code> å¯¹åº”çš„è¡¨ï¼Œè¿™æ˜¯è€ƒè™‘åˆ°ä¸€ä¸ªä¿¡é“å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…ã€‚å¾ˆæ˜¾ç„¶ï¼Œå‰æ–‡æåˆ°çš„åœ¨ <code>DataVisitor</code> æ„é€ æ—¶ï¼Œè°ƒç”¨ <code>AddNotifier()</code> å°±æ˜¯è¦æŠŠè‡ªå·±çš„ <code>Notifier</code> å­˜åˆ°è¿™ä¸ªè¡¨ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataNotifier</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AddNotifier</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> channel_id, <span class="hljs-type">const</span> std::shared_ptr&lt;Notifier&gt;&amp; notifier)</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Notify</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> channel_id)</span></span>;<br> <span class="hljs-keyword">private</span>:<br>  AtomicHashMap&lt;<span class="hljs-type">uint64_t</span>, NotifyVector&gt; notifies_map_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>è‡³äº <code>AddNotifier()</code> å‡½æ•°çš„å®ç°ï¼Œemmâ€¦â€¦å¾ˆå¹³å‡¡ï¼Œæ— éå°±æ˜¯æ‰¾åˆ°å¯¹åº”çš„ä¿¡é“ id ï¼Œç„¶åå°†å‚æ•°ä¸­çš„ <code>Notifier</code> æ”¾å…¥åˆ°æ•°ç»„é‡Œï¼ˆå¦‚æœæ²¡æœ‰æ•°ç»„ï¼Œæ–°å»ºä¸€ä¸ªï¼‰ã€‚é‡è¦çš„æ˜¯å”¤é†’å‡½æ•° <code>Notify()</code> ï¼Œè¯¥å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ <code>notifier-&gt;callback()</code> ï¼Œå›é¡¾ä¸€ä¸‹ï¼Œè¿™ä¸ª <code>notifier</code> æ˜¯åœ¨ <code>Scheduler</code> åˆ›å»ºä»»åŠ¡æ—¶è¢«è®¾ç½®çš„ï¼Œå†…å«æœ‰ <code>NotifyProcessor()</code> å‡½æ•°ï¼Œå¯ä»¥å”¤é†’åç¨‹ã€‚åœ¨ <a href="#2">Receiver &amp;&amp; Transmitter</a> å’Œ <a href="#1">ReceiverManager</a> ä¹Ÿæåˆ°ï¼Œç¬¬äºŒæ­¥çš„åˆ†å‘å™¨æœ€ç»ˆä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå”¤é†’æ‰€æœ‰ç›‘å¬è¯¥ä¿¡é“çš„åç¨‹ï¼Œæ¥å¤„ç†åˆ°æ¥çš„æ¶ˆæ¯ã€‚è¿™æ ·ï¼Œä½ ä¹Ÿå°±æ˜ç™½ä¸ºä»€ä¹ˆ <code>DataVisitor</code> ç±»åœ¨æ„é€ æ—¶è¦æŠŠ <code>notifier</code> åŠ å…¥è¿›å»äº†ï¼Œä¸ç„¶çš„è¯ä¿¡é“æ¥äº†ä¸ªæ¶ˆæ¯ï¼Œå°±æ²¡æ³•å”¤é†’åç¨‹ï¼Œ<code>Reader</code> å°±ä¸çŸ¥é“äº†å‘€ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">DataNotifier::Notify</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> channel_id)</span> </span>&#123;<br>  NotifyVector* notifies = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (notifies_map_.<span class="hljs-built_in">Get</span>(channel_id, &amp;notifies)) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; notifier : *notifies)<br>      <span class="hljs-keyword">if</span> (notifier &amp;&amp; notifier-&gt;callback)<br>        notifier-&gt;<span class="hljs-built_in">callback</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="DataFusion-AllLatest">DataFusion &amp; AllLatest</h3>
<p>å†æ¥çœ‹çœ‹ <code>DataVisitor</code> æ„é€ å‡½æ•°çš„æœ€åä¸€æ­¥ï¼Œåˆ›å»º <code>DataFusion</code> å¯¹è±¡ï¼Œçœ‹çœ‹åå­—ï¼Œå°±åº”è¯¥æ˜ç™½è¯¥å¯¹è±¡ç”¨äºä¿¡é“æ•°æ®çš„èåˆã€‚<code>DataFusion</code> æ˜¯ <code>AllLatest</code> çš„åŸºç±»ï¼Œ<code>DataFusion</code> ç±»ååˆ†ç®€å•ï¼Œä»…æä¾›äº†ä¸€ä¸ª <code>Fusion()</code> æ¥å£ï¼Œå…·ä½“ç”± <code>AllLatest</code> å®ç°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹ <code>AllLatest</code> ç±»ï¼Œå“ˆï¼Œå¬åå­—å°±çŸ¥é“å®ƒä¼šå–æ‰€æœ‰ä¿¡é“ä¸­çš„<strong>æœ€æ–°å€¼</strong>ï¼Œå†ç»“åˆå®ƒæ˜¯ <code>DataFusion</code> çš„å­ç±»ï¼Œæ‰€ä»¥ä¸»è¦åŠŸèƒ½åº”è¯¥æ˜¯<strong>èåˆå¤šä¸ªä¿¡é“çš„æœ€æ–°æ•°æ®</strong>ã€‚</p>
<p>æˆ‘è¿˜æ˜¯ä»¥ä¸¤ä¸ªä¿¡é“çš„æƒ…å†µä¸ºä¾‹ï¼Œè¯¥ç±»æˆå‘˜æœ‰å‡ ä¸ª <code>ChannelBuffer</code> ç±»ï¼Œå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šï¼Œç±»å‹æ˜¯æ•°æ®èåˆçš„ <code>buffer_fusion_</code> ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> M0, <span class="hljs-keyword">typename</span> M1&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AllLatest</span>&lt;M0, M1, NullType, NullType&gt; : <span class="hljs-keyword">public</span> DataFusion&lt;M0, M1&gt; &#123;<br>     <span class="hljs-comment">// æ‰€è°“èåˆæ¶ˆæ¯ï¼Œå°±æ˜¯æ”¾åœ¨ tuple é‡Œ</span><br> <span class="hljs-keyword">using</span> FusionDataType = std::tuple&lt;std::shared_ptr&lt;M0&gt;, std::shared_ptr&lt;M1&gt;&gt;;<br> <span class="hljs-keyword">private</span>:<br>  ChannelBuffer&lt;M0&gt; buffer_m0_;<br>  ChannelBuffer&lt;M1&gt; buffer_m1_;<br>  ChannelBuffer&lt;FusionDataType&gt; buffer_fusion_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œç‰¹æ®Šçš„ä¿¡é“ 0 çš„æ¶ˆæ¯ç¼“å†²åŒºä¼šè°ƒç”¨ <code>SetFusionCallback()</code> æ¥è®¾ç½®<strong>å›è°ƒå‡½æ•°</strong> :point_down:ï¼Œ<em>ä¸ºæ–¹ä¾¿è¡¨è¿°ï¼Œæˆ‘ç»™å®ƒèµ·å <code>FusionFunc</code></em> ã€‚ä»ä¸‹é¢çš„ä»£ç ä¸­çœ‹å‡ºï¼Œ <code>FusionFunc</code> å…ˆåˆ¤æ–­æ˜¯å¦æ‰€æœ‰ä¿¡é“éƒ½æœ‰æ¶ˆæ¯ï¼Œå¹¶è·å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœéƒ½æœ‰æ¶ˆæ¯çš„è¯å°±å°†è¿™äº›æ¶ˆæ¯èåˆï¼Œå³ç”¨ <code>std::tuple</code> å°è£…ï¼Œå†è°ƒç”¨ <code>Fill()</code> å‡½æ•°å¡«å…¥åˆ° <code>buffer_fusion_</code> çš„ <code>CacheBuffer</code> ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">AllLatest</span>(<span class="hljs-type">const</span> ChannelBuffer&lt;M0&gt;&amp; buffer_0, <span class="hljs-type">const</span> ChannelBuffer&lt;M1&gt;&amp; buffer_1)<br>      : <span class="hljs-built_in">buffer_m0_</span>(buffer_0), <span class="hljs-built_in">buffer_m1_</span>(buffer_1),<br>        <span class="hljs-built_in">buffer_fusion_</span>(buffer_m0_.<span class="hljs-built_in">channel_id</span>(),<br>           <span class="hljs-keyword">new</span> CacheBuffer&lt;std::shared_ptr&lt;FusionDataType&gt;&gt;(<br>              buffer_0.<span class="hljs-built_in">Buffer</span>()-&gt;<span class="hljs-built_in">Capacity</span>() - <span class="hljs-built_in">uint64_t</span>(<span class="hljs-number">1</span>))) &#123;<br>    buffer_m0_.<span class="hljs-built_in">Buffer</span>()-&gt;<span class="hljs-built_in">SetFusionCallback</span>( <span class="hljs-comment">// buffer0 è®¾ç½®èåˆçš„å›è°ƒå‡½æ•°</span><br>        [<span class="hljs-keyword">this</span>](<span class="hljs-type">const</span> std::shared_ptr&lt;M0&gt;&amp; m0) &#123;<br>          std::shared_ptr&lt;M1&gt; m1;<br>          <span class="hljs-keyword">if</span> (!buffer_m1_.<span class="hljs-built_in">Latest</span>(m1)) <span class="hljs-comment">// ä¿¡é“å†…æ˜¯å¦æœ‰æ¶ˆæ¯ æœ‰çš„è¯å–å‡ºæœ€åä¸€ä¸ª</span><br>            <span class="hljs-keyword">return</span>;<br>          <span class="hljs-keyword">auto</span> data = std::<span class="hljs-built_in">make_shared</span>&lt;FusionDataType&gt;(m0, m1);<br>          std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lg</span>(buffer_fusion_.<span class="hljs-built_in">Buffer</span>()-&gt;<span class="hljs-built_in">Mutex</span>());<br>          <span class="hljs-comment">// å¡«å……åˆ°æ¶ˆæ¯ä¸­</span><br>          buffer_fusion_.<span class="hljs-built_in">Buffer</span>()-&gt;<span class="hljs-built_in">Fill</span>(data);<br>        &#125;);<br>  &#125;<br></code></pre></td></tr></table></figure>
<p><strong>ä½•æ—¶è°ƒç”¨</strong> <code>FusionFunc</code> å‘¢ï¼Ÿç­”æ¡ˆåœ¨è¿™ä¸ª <code>Fill()</code> å‡½æ•°ï¼ˆè§ä¸‹ä»£ç ï¼‰ä¸­ï¼Œå®ƒè¯¡è®¡å¤šç«¯â€”â€”å¦‚æœ <code>CacheBuffer</code> æœ‰å›è°ƒå‡½æ•° <code>FusionFunc</code>ï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼›å¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ¥æ”¶åˆ°çš„æ•°æ®æ”¾å…¥ç¼“å†²åŒºä¸­ã€‚å¾ˆæ˜¾ç„¶åœ¨ä¸Šé¢çš„æ„é€ å‡½æ•°ä¸­ï¼Œåªæœ‰ä¿¡é“ 0 è®¾ç½®äº†å›è°ƒå‡½æ•° <code>FusionFunc</code>ã€‚<em>å› æ­¤å½“ä¿¡é“ 0 æœ‰æ•°æ®åˆ°æ¥ï¼Œ <code>DataDispatcher::Dispatch()</code> è¢«è°ƒç”¨æ—¶ï¼ˆä»£ç è§ DataDispatcher éƒ¨åˆ†ï¼‰ï¼Œè¿›è€Œè°ƒç”¨ <code>Fill()</code> å‡½æ•°æ—¶ï¼Œ <code>FusionFunc</code> æ‰ä¼šè¢«è°ƒç”¨</em>ï¼Œå°†æœ€æ–°çš„æ¶ˆæ¯èåˆï¼Œå¹¶å°†èåˆçš„æ¶ˆæ¯å¡«å…¥åˆ° <code>buffer_fusion_</code> ä¸­ã€‚è€Œå…¶ä»–ä¿¡é“çš„æ•°æ®åˆ°æ¥æ—¶ï¼Œ <code>Fill()</code> å‡½æ•°åªæ˜¯å•çº¯å¾€å¯¹åº”çš„ <code>CacheBuffer</code> ä¸­å¡«æ•°æ®ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CacheBuffer::Fill</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; value)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (fusion_callback_)<br>    <span class="hljs-built_in">fusion_callback_</span>(value);  <span class="hljs-comment">// buffer 0 è¿è¡Œè¿™ä¸ª</span><br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Full</span>()) &#123;<br>      buffer_[<span class="hljs-built_in">GetIndex</span>(head_)] = value;<br>      ++head_;     ++tail_;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      buffer_[<span class="hljs-built_in">GetIndex</span>(tail_ + <span class="hljs-number">1</span>)] = value;<br>      ++tail_;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>åœ¨åç¨‹çš„å¤„ç†å‡½æ•°ä¸­ï¼ˆå›é¡¾ä¸€ä¸‹ï¼Œ DataVisitor çš„åˆ›å»ºåç¨‹å·¥å‚ä¸­æåˆ°çš„ï¼‰ä¼šè°ƒç”¨ <code>DataVisitor::TryFetch()</code> å‡½æ•°ï¼Œå†è°ƒç”¨ <code>Fusion()</code> å‡½æ•°ï¼ˆä»£ç å¦‚ä¸‹ï¼‰ï¼Œå®ƒä»èåˆæ•°æ®çš„ç¼“å†²åŒº <code>buffer_fusion_</code> ä¸­æ‹¿èµ°ï¼ˆFetchï¼‰èåˆæ¶ˆæ¯ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åŒæ—¶æ‹¿å¤šä¸ªä¿¡é“ä¸Šçš„æœ€æ–°æ¶ˆæ¯ï¼Œä¿è¯äº†æ¯æ¬¡ç»™ <code>Component::Process()</code> å‡½æ•°çš„å‚æ•°éƒ½å¿…é¡»â€œå…¨å‘˜åˆ°é½â€ï¼Œå¹¶ä¸”æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯æœ€æ–°çš„ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œåªæœ‰ä¿¡é“ 0 æ”¶åˆ°æ¶ˆæ¯åï¼Œæ‰ä¼šèåˆå…¶ä»–ä¿¡é“çš„æ¶ˆæ¯ï¼Œå¾€å¾€ä¸»å¯¼é€šä¿¡å¤„ç†çš„èŠ‚å¥ï¼Œå› æ­¤ä¿¡é“ 0 çš„é€‰å–å°±æ¯”è¾ƒå…³é”®äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DataVisitor::TryFetch</span><span class="hljs-params">(std::shared_ptr&lt;M0&gt;&amp; m0, std::shared_ptr&lt;M1&gt;&amp; m1)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (data_fusion_-&gt;<span class="hljs-built_in">Fusion</span>(&amp;next_msg_index_, m0, m1)) &#123;<br>    next_msg_index_++;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">AllLatest::Fusion</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span>* index, std::shared_ptr&lt;M0&gt;&amp; m0,</span></span><br><span class="hljs-params"><span class="hljs-function">              std::shared_ptr&lt;M1&gt;&amp; m1)</span> <span class="hljs-keyword">override</span> </span>&#123;<br>  std::shared_ptr&lt;FusionDataType&gt; fusion_data;<br>  <span class="hljs-comment">// ä» fusion ç¼“å†²åŒºä¸­å–æ•°æ®</span><br>  <span class="hljs-keyword">if</span> (!buffer_fusion_.<span class="hljs-built_in">Fetch</span>(index, fusion_data))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// å¾—åˆ°äº†æ•°æ® åˆ†åˆ«èµ‹å€¼ç»™ m0 m1</span><br>  m0 = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(*fusion_data);<br>  m1 = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(*fusion_data);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="ChannelBuffer-CacheBuffer">ChannelBuffer &amp; CacheBuffer</h3>
<p>å‰æ–‡æˆ‘ä¸€ç›´æåˆ°ä¸€ä¸ªè¯ï¼Œå«åšç¼“å†²åŒºã€‚äº‹å®ä¸Šè¿™ä¸ªè¯å…·ä½“æŒ‡å‘äº†ä¸¤ä¸ªç±»ï¼Œ<code>ChannelBuffer</code> å’Œ <code>CacheBuffer</code> ç±»ã€‚ä¸ºäº†è®©è¯»è€…æ›´å¥½åœ°ç†è§£â€œç¼“å†²åŒºâ€è¿™ä¸ªè¯ï¼Œæˆ‘ç®€è¦åœ°ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªç±»ã€‚<code>ChannelBuffer</code> ç±»åŒ…å«äº†ä¸¤ä¸ªæˆå‘˜ï¼šä¿¡é“ id å’Œ æŒ‡å‘ <code>CacheBuffer</code> çš„æŒ‡é’ˆã€‚å®ƒçš„å‡½æ•° <code>Fetch()</code> å’Œ <code>Latest()</code> åˆ†åˆ«ç”¨äºå–å¯¹åº”ç´¢å¼•çš„æ¶ˆæ¯å’Œå–å¾—æœ€æ–°æ¶ˆæ¯ã€‚è€Œ <code>CacheBuffer</code> ç±»ï¼Œå…¶å®è´¨å°±æ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—ï¼Œç”¨æ¥æ”¾ç½®æŸä¸ªä¿¡é“äº§ç”Ÿçš„æ•°æ®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>CacheBuffer</code> å ç”¨çš„å†…å­˜æ˜¯æ’å®šçš„ï¼Œå› ä¸ºé‡Œé¢çš„æ•°ç»„é•¿åº¦ä¸€å¼€å§‹å°±è¢«é™å®šäº†ï¼Œæ‰€ä»¥ï¼Œä¸€æ—¦ç¼“å†²åŒºè£…æ»¡äº†ï¼Œå®ƒä¼šæ¯«ä¸çŠ¹è±«åœ°ä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯ï¼Œæ¨å…¥æœ€æ–°çš„æ¶ˆæ¯ã€‚å…·ä½“çš„é˜Ÿåˆ—å®ç°åœ¨ <code>cyber/data/cache_buffer.h</code> å’Œ <code>cyber/data/channel_buffer.h</code>ï¼Œå¾ˆç®€å•ï¼Œæœ‰å…´è¶£å¯ä»¥ç›´æ¥è¯»ä»£ç ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>(âŠ™oâŠ™)å“¦ç»ˆäºï¼Œæˆ‘æŠŠ Cyber RT æ‰€æœ‰çš„é€šä¿¡æœºåˆ¶éƒ½çœ‹å®Œäº†ï¼Œå“¦ï¼ŒBTWï¼Œä¸Šç¯‡é€šä¿¡é“¾æ¥åœ¨<a href="https://dingfen.github.io/apollo/2020/11/03/CyberCommu1.html">è¿™é‡Œ</a>ã€‚ç°åœ¨ï¼Œåœ¨æŠŠæ‰€æœ‰çš„å†…å®¹éƒ½ææ˜ç™½åï¼Œè®©æˆ‘ä»¬ç†ä¸€ç†è‡ªå·±æ˜æ²‰çš„å¤´è„‘ï¼Œè·³è„±å‡ºä»£ç çš„è¾¹è¾¹æ¡†æ¡†ï¼Œä»ä¸Šå¸è§†è§’å®¡è§†ä¸€ä¸‹æ•°æ®æ˜¯å¦‚ä½•æµé€šçš„ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸¤å¼ éå¸¸å¥½çš„å›¾ï¼Œæ„Ÿè°¢ [2]ï¼Œæˆ‘å¯ä»¥ä¸ç”¨è‡ªå·±åŠ¨æ‰‹ï¼ŒèŠ±è´¹æ•°å°æ—¶ç”»å›¾äº†ğŸ˜€</p>
<p><img src="/img/msg.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>åœ¨ä¸Šé¢è¿™å¼ å›¾ä¸­ï¼Œä»ç„¶ä»¥ä¸¤ä¸ªä¿¡é“çš„ <code>Component</code> ä¸ºä¾‹ï¼Œä»å·¦ä¸Šè§’å‡ºå‘ï¼š</p>
<ul>
<li><code>Component</code> åˆå§‹åŒ–å»ºæˆäº†ä¸¤ä¸ª <code>Reader</code> å¯¹è±¡ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ª <code>DataVisitor&lt;M0, M1&gt;</code> å¯¹è±¡</li>
<li>ä¸¤ä¸ª <code>Reader</code> å¯¹è±¡ä¹Ÿåˆ†åˆ«åˆ›å»ºäº†ä¸€ä¸ª <code>DataVisitor&lt;&gt;</code> å¯¹è±¡ï¼Œå›é¡¾ä¸€ä¸‹ä¸Šç¯‡æåˆ°çš„ <code>Reader</code> çš„åˆå§‹åŒ–è¿‡ç¨‹</li>
<li>è¿™äº› <code>DataVisitor</code> å¯¹è±¡ä¼šåˆ†åˆ«åˆ›å»ºå‡º <code>ChannelBuffer</code> ï¼Œå¹¶ä½¿ç”¨ <code>DataDispatcher</code> ç®¡ç†è¿™äº›ç¼“å†²åŒºï¼ˆæ³¨æ„çœ‹å®ƒå†…éƒ¨çš„è¡¨ï¼‰</li>
<li>å½“æ¥æ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œ<code>DataDispatcher</code> ä¼šç»™å¯¹åº”çš„ä¿¡é“ä¸Šçš„æ‰€æœ‰ç¼“å†²åŒºè¿›è¡Œåˆ†æ´¾ï¼Œç‰¹åˆ«åœ°ï¼Œè‹¥ä¿¡é“ 0 æœ‰æ–°æ¶ˆæ¯ï¼Œè¿˜ä¼šå¯¹å…¶ä»–æ¶ˆæ¯è¿›è¡Œèåˆï¼ˆæ³¨æ„çœ‹ <code>AllLatest</code> å¯¹è±¡ï¼‰</li>
<li>ä¹‹åï¼Œ<code>DataVisitor</code> ä¼šä½¿ç”¨ <code>DataNotifier</code> å¯¹è±¡ï¼Œå”¤é†’ç›¸åº”çš„åç¨‹ï¼Œå¤„ç†æ”¶åˆ°çš„æ•°æ®</li>
</ul>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹åº•å±‚çš„é€šä¿¡æ¶æ„ï¼Œè™½ç„¶æœ‰äº›éƒ¨åˆ†æˆ‘ç•¥å»æœªè®²ï¼Œä½†è¿™å¼ å›¾æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥çœ‹æ˜ç™½çš„ğŸ¶ã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬ä»æœ€å³è¾¹å¼€å§‹çœ‹èµ·ã€‚</p>
<p><img src="/img/msg2.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li>å¯ä»¥çœ‹å‡ºä¸¤ä¸ª <code>Reader</code> å¯¹è±¡å…±ç”¨äº†ä¸€ä¸ª <code>Receiver</code> ã€‚è¿™æ˜¯å› ä¸ºåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œä¸åŒçš„ <code>Reader</code> å¯¹è±¡è®¢é˜…åŒä¸€ä¸ªä¿¡é“ï¼Œå°±ä¼šä½¿ç”¨åŒä¸€ä¸ª <code>Receiver</code></li>
<li>é»˜è®¤é€‰æ‹©çš„ <code>Receiver</code> æ˜¯ hybrid çš„ï¼Œå› æ­¤éœ€è¦ä¸‰ä¸ªåº•å±‚æ¥æ”¶ç±» <code>IntraReceiver</code> ã€<code>ShmReceiver</code> å’Œ <code>RtpsReceiver</code> é…åˆ</li>
<li>åœ¨åˆ›å»º <code>Receiver</code> æ—¶ï¼Œç›‘å¬è€…å¤„ç†å‡½æ•° <code>msg_listener_</code> å°±å·²ç»â€œå‡†å¤‡å°±ç»ªâ€äº†ã€‚</li>
<li><code>Dispatcher</code> çš„è¡¨ä¸­è®°å½•äº†ç›‘å¬è€…å’Œå®ƒä»¬è´Ÿè´£çš„ä¿¡é“ï¼Œå¹¶æŠŠå®ƒä»¬è¿æ¥ <code>Connect</code> èµ·æ¥ï¼Œå¦‚åŒ Qt ä¸­çš„ä¿¡å·æ§½æœºåˆ¶</li>
<li>ä¸€æœ‰æ–°æ¶ˆæ¯åˆ°è¾¾ï¼ˆæœ€å·¦è¾¹çš„å‡½æ•°æ˜¯æˆ‘é™Œç”Ÿçš„ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šç«‹åˆ»è§¦å‘ä¿¡å·æ§½æœºåˆ¶ï¼Œè°ƒç”¨ <code>msg_listener</code> å‡½æ•°ï¼Œä¹‹åå°±æ˜¯ä¸Šå±‚ <code>DataDispatcher</code> çš„å·¥ä½œäº†</li>
</ul>
<p>æœ€åçš„æœ€åï¼Œäº‹å®ä¸Šæˆ‘è¿˜æ˜¯è½äº†ä¸€ä¸ªä¸œè¥¿ï¼šæœåŠ¡â€”å®¢æˆ·é€šä¿¡æ–¹å¼ğŸ˜“ğŸ˜“ğŸ˜‚ğŸ˜‚ã€‚çš„ç¡®ï¼Œè¿™ç¯‡åšå®¢çš„å†…å®¹å…¨æ˜¯å…³äºå‘å¸ƒâ€”è®¢é˜…é€šä¿¡æ–¹å¼çš„ï¼Œå¯¹äº <code>Service</code> å’Œ <code>Client</code> ï¼Œå‡ ä¹æ²¡æœ‰æåŠï¼Œä¹‹åï¼Œæˆ‘å°±ä¼šè¡¥ä¸Šè¿™ä¸€éƒ¨åˆ†æœåŠ¡å‘ç°çš„å†…å®¹ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p>[1] <a target="_blank" rel="noopener" href="https://github.com/daohu527/Dig-into-Apollo/tree/master/cyber">Dig into Apollo - Cyber</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://blog.csdn.net/jinzhuojun/article/details/108066714">è‡ªåŠ¨é©¾é©¶å¹³å°Apollo 5.5é˜…è¯»æ‰‹è®°ï¼šCyber RTä¸­çš„é€šä¿¡ä¼ è¾“</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_25762163/article/details/103803032">ç™¾åº¦Apolloç³»ç»Ÿå­¦ä¹ -Cyber RT é€šä¿¡-ä¸Šå±‚</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://blog.csdn.net/kesalin/article/details/88914029">ç™¾åº¦ Apollo Cyber RTç®€ä»‹ã€åŸºæœ¬æ¦‚å¿µä»¥åŠä¸ ROS å¯¹ç…§</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_25762163/article/details/103895527">ç™¾åº¦Apolloç³»ç»Ÿå­¦ä¹ -Cyber RT é€šä¿¡-åº•å±‚</a></p>
<p>[6] <a target="_blank" rel="noopener" href="https://cyber-rt.readthedocs.io/en/latest/api/cppapi.html#cyber-node-reader-h">cyber-rt.readthedocs.io</a></p>
<p>[7] è‡ªåŠ¨é©¾é©¶æ±½è½¦å¹³å°æŠ€æœ¯åŸºç¡€/æ¨ä¸–æ˜¥ç­‰ç¼–è‘—. â€”åŒ—äº¬ï¼šæ¸…åå¤§å­¦å‡ºç‰ˆç¤¾</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Apollo/" class="category-chain-item">Apollo</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Apollo/" class="print-no-link">#Apollo</a>
      
        <a href="/tags/Cyber-RT/" class="print-no-link">#Cyber RT</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Apollo Cyber RT é€šä¿¡ï¼ˆä¸‹ï¼‰</div>
      <div>https://dingfen.github.io/2020/11/07/2020-11-7-CyberCommu2/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Bill Ding</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2020å¹´11æœˆ7æ—¥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2025å¹´1æœˆ26æ—¥</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - ç›¸åŒæ–¹å¼å…±äº«">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/11/11/2020-11-11-ApolloPlanning/" title="Apollo Planning è§„åˆ’æ¨¡å—">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Apollo Planning è§„åˆ’æ¨¡å—</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/11/03/2020-11-3-CyberCommu1/" title="Apollo Cyber RT é€šä¿¡ï¼ˆä¸Šï¼‰">
                        <span class="hidden-mobile">Apollo Cyber RT é€šä¿¡ï¼ˆä¸Šï¼‰</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'zh-cn'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/zh-cn.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/Ribbon.min.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
<!-- hexo injector body_end start -->
  <link rel="stylesheet" crossorigin href="https://g.alicdn.com/aliyun-documentation/web-chatbot-ui/0.0.11/index.css" />
  <script type="module" crossorigin src="https://g.alicdn.com/aliyun-documentation/web-chatbot-ui/0.0.11/index.js"></script>
  <script>
    window.CHATBOT_CONFIG = {
      endpoint: "https://web-chatbot-syz-knthhrjfeq.cn-hangzhou.fcapp.run/chat", // å¯ä»¥æ›¿æ¢ä¸º https://{your-fc-http-trigger-domain}/chat
      displayByDefault: false, // é»˜è®¤ä¸æ˜¾ç¤º AI åŠ©æ‰‹å¯¹è¯æ¡†
      aiChatOptions: { // è‡ªå®šä¹‰å–å€¼å‚è€ƒï¼šhttps://docs.nlkit.com/nlux/reference/ui/ai-chat#conversation-options
        conversationOptions: { // è‡ªå®šä¹‰å–å€¼å‚è€ƒï¼šhttps://docs.nlkit.com/nlux/reference/ui/ai-chat#conversation-options
          conversationStarters: [
            {prompt: 'è¯·é—®ä½ æ˜¯è°ï¼Œèƒ½ä¸ºæˆ‘åšä»€ä¹ˆï¼Ÿ'},
            {prompt: 'è¯·ä»‹ç»ä¸€ä¸‹åšå®¢çš„ä¸»äºº'}
          ],
          layout: 'bubbles'
        },
        displayOptions: { // è‡ªå®šä¹‰å–å€¼å‚è€ƒï¼šhttps://docs.nlkit.com/nlux/reference/ui/ai-chat#display-options
          height: 550,
          // width: 400,
        },
        personaOptions: { // è‡ªå®šä¹‰å–å€¼å‚è€ƒï¼šhttps://docs.nlkit.com/nlux/reference/ui/ai-chat#chat-personas
          assistant: {
            name: 'ä½ å¥½ï¼Œæˆ‘æ˜¯æœ¬ç½‘ç«™çš„ AI åŠ©æ‰‹',
            // AI åŠ©æ‰‹çš„å›¾æ ‡
            avatar: 'https://img.alicdn.com/imgextra/i2/O1CN01Pda9nq1YDV0mnZ31H_!!6000000003025-54-tps-120-120.apng',
            tagline: 'è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä¼šå°½åŠ›å¸®ä½ è§£ç­”ï¼',
          }
        }
      }
    };
  </script>
  <style>
    :root {
      /* webchat å·¥å…·æ çš„é¢œè‰² */
      --webchat-toolbar-background-color: #1464E4;
      /* webchat å·¥å…·æ æ–‡å­—å’ŒæŒ‰é’®çš„é¢œè‰² */
      --webchat-toolbar-text-color: #FFF;
    }
    /* webchat å¯¹è¯æ¡†å¦‚æœè¢«é®æŒ¡ï¼Œå¯ä»¥å°è¯•é€šè¿‡ z-indexã€bottomã€right ç­‰è®¾ç½® æ¥è°ƒæ•´*/
    .webchat-container {
      z-index: 100;
      bottom: 10px;
      right: 10px;
    }
    /* webchat çš„å”¤èµ·æŒ‰é’®å¦‚æœè¢«é®æŒ¡ï¼Œå¯ä»¥å°è¯•é€šè¿‡ z-indexã€bottomã€right ç­‰è®¾ç½® æ¥è°ƒæ•´ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ CSS è¿›ä¸€æ­¥å®šåˆ¶å”¤èµ·æŒ‰é’®çš„å½¢çŠ¶ã€å¤§å°ç­‰ã€‚ */
    .webchat-bubble-tip {
      z-index: 99;
      bottom: 20px;
      right: 20px;
    }
  </style>
  <!-- hexo injector body_end end --></body>
</html>
